<!DOCTYPE html>
<html>
<head>
<title>Spectrum ROM: Routine at 04381</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Spectrum ROM" src="../../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="4264.html">04264</a>
</td>
<td class="up">Up: <a href="../maps/all.html#4381">Map</a></td>
<td class="next">
Next: <a href="4496.html">04496</a>
</td>
</tr>
</table>
<div class="description">04381: THE 'LOWER SCREEN COPYING' SUBROUTINE</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="4264.html">KEY_INPUT</a> and <a href="8329.html">INPUT</a>.
</div>
<div class="paragraph">
This subroutine is called whenever the line in the editing area or the INPUT area is to be printed in the lower part of the screen.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ED_COPY</td>
<td class="address-2"><span id="4381"></span>04381</td>
<td class="instruction">CALL <a href="3405.html">TEMPS</a></td>
<td class="comment-1" rowspan="1">Use the permanent colours.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4384"></span>04384</td>
<td class="instruction">RES 3,(IY+2)</td>
<td class="comment-1" rowspan="2">Signal that the 'mode is to be considered unchanged' (reset bit 3 of <a href="23612.html">TV-FLAG</a>) and the 'lower screen does not need clearing' (reset bit 5).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4388"></span>04388</td>
<td class="instruction">RES 5,(IY+2)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4392"></span>04392</td>
<td class="instruction">LD HL,(23690)</td>
<td class="comment-1" rowspan="2">Save the current value of <a href="23690.html">S-POSNL</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4395"></span>04395</td>
<td class="instruction">PUSH HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4396"></span>04396</td>
<td class="instruction">LD HL,(23613)</td>
<td class="comment-1" rowspan="2">Keep the current value of <a href="23613.html">ERR-SP</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4399"></span>04399</td>
<td class="instruction">PUSH HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4400"></span>04400</td>
<td class="instruction">LD HL,4455</td>
<td class="comment-1" rowspan="1">This is <a href="4381.html#4455">ED_FULL</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4403"></span>04403</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="2">Push this address on to the machine stack to make <a href="4381.html#4455">ED_FULL</a> the entry point following an error (see <a href="23613.html">ERR-SP</a>).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4404"></span>04404</td>
<td class="instruction">LD (23613),SP</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4408"></span>04408</td>
<td class="instruction">LD HL,(23682)</td>
<td class="comment-1" rowspan="2">Push the value of <a href="23682.html">ECHO-E</a> on to the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4411"></span>04411</td>
<td class="instruction">PUSH HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4412"></span>04412</td>
<td class="instruction">SCF</td>
<td class="comment-1" rowspan="3">Make <span class="register">HL</span> point to the start of the space and <span class="register">DE</span> the end.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4413"></span>04413</td>
<td class="instruction">CALL <a href="4496.html#4501">SET_DE</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4416"></span>04416</td>
<td class="instruction">EX DE,HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4417"></span>04417</td>
<td class="instruction">CALL <a href="6229.html#6269">OUT_LINE2</a></td>
<td class="comment-1" rowspan="1">Now print the line.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4420"></span>04420</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="2">Exchange the pointers and print the cursor.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4421"></span>04421</td>
<td class="instruction">CALL <a href="6369.html">OUT_CURS</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4424"></span>04424</td>
<td class="instruction">LD HL,(23690)</td>
<td class="comment-1" rowspan="2">Next fetch the current value of <a href="23690.html">S-POSNL</a> and exchange it with <a href="23682.html">ECHO-E</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4427"></span>04427</td>
<td class="instruction">EX (SP),HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4428"></span>04428</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Pass <a href="23682.html">ECHO-E</a> to <span class="register">DE</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4429"></span>04429</td>
<td class="instruction">CALL <a href="3405.html">TEMPS</a></td>
<td class="comment-1" rowspan="1">Again fetch the permanent colours.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="4432"></span>
<div class="comments">
<div class="paragraph">
The remainder of any line that has been started is now completed with spaces printed with the 'permanent' PAPER colour.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ED_BLANK</td>
<td class="address-2"><span id="4432"></span>04432</td>
<td class="instruction">LD A,(23691)</td>
<td class="comment-1" rowspan="2">Fetch the current line number from <a href="23690.html">S-POSNL</a> and subtract the old line number.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4435"></span>04435</td>
<td class="instruction">SUB D</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4436"></span>04436</td>
<td class="instruction">JR C,<a href="4381.html#4476">ED_C_DONE</a></td>
<td class="comment-1" rowspan="1">Jump forward if no 'blanking' of lines required.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4438"></span>04438</td>
<td class="instruction">JR NZ,<a href="4381.html#4446">ED_SPACES</a></td>
<td class="comment-1" rowspan="1">Jump forward if not on the same line.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4440"></span>04440</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="2">Fetch the old column number and subtract the new column number (at <a href="23690.html">S-POSNL</a>).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4441"></span>04441</td>
<td class="instruction">SUB (IY+80)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4444"></span>04444</td>
<td class="instruction">JR NC,<a href="4381.html#4476">ED_C_DONE</a></td>
<td class="comment-1" rowspan="1">Jump if no spaces required.</td>
</tr>
<tr>
<td class="asm-label">ED_SPACES</td>
<td class="address-2"><span id="4446"></span>04446</td>
<td class="instruction">LD A," "</td>
<td class="comment-1" rowspan="1">A 'space'.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4448"></span>04448</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1">Save the old values.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4449"></span>04449</td>
<td class="instruction">CALL <a href="2548.html">PRINT_OUT</a></td>
<td class="comment-1" rowspan="1">Print it.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4452"></span>04452</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1">Fetch the old values.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4453"></span>04453</td>
<td class="instruction">JR <a href="4381.html#4432">ED_BLANK</a></td>
<td class="comment-1" rowspan="1">Back again.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="4455"></span>
<div class="comments">
<div class="paragraph">
New deal with any errors.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ED_FULL</td>
<td class="address-1"><span id="4455"></span>04455</td>
<td class="instruction">LD D,0</td>
<td class="comment-1" rowspan="4">Give out a 'rasp' (see <a href="23608.html">RASP</a>).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4457"></span>04457</td>
<td class="instruction">LD E,(IY-2)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4460"></span>04460</td>
<td class="instruction">LD HL,6800</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4463"></span>04463</td>
<td class="instruction">CALL <a href="949.html">BEEPER</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4466"></span>04466</td>
<td class="instruction">LD (IY+0),255</td>
<td class="comment-1" rowspan="1">Cancel the error number (<a href="23610.html">ERR-NR</a>).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4470"></span>04470</td>
<td class="instruction">LD DE,(23690)</td>
<td class="comment-1" rowspan="2">Fetch the current value of <a href="23690.html">S-POSNL</a> and jump forward.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4474"></span>04474</td>
<td class="instruction">JR <a href="4381.html#4478">ED_C_END</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="4476"></span>
<div class="comments">
<div class="paragraph">
The normal exit upon completion of the copying over of the edit or the INPUT line.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ED_C_DONE</td>
<td class="address-2"><span id="4476"></span>04476</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1">The new position value.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4477"></span>04477</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">The 'error address'.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="4478"></span>
<div class="comments">
<div class="paragraph">
But come here after an error.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ED_C_END</td>
<td class="address-2"><span id="4478"></span>04478</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="2">The old value of <a href="23613.html">ERR-SP</a> is restored.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4479"></span>04479</td>
<td class="instruction">LD (23613),HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4482"></span>04482</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Fetch the old value of <a href="23690.html">S-POSNL</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4483"></span>04483</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1">Save the new position values.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4484"></span>04484</td>
<td class="instruction">CALL <a href="3545.html">CL_SET</a></td>
<td class="comment-1" rowspan="1">Set the system variables.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4487"></span>04487</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="2">The old value of <a href="23690.html">S-POSNL</a> goes into <a href="23682.html">ECHO-E</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4488"></span>04488</td>
<td class="instruction">LD (23682),HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4491"></span>04491</td>
<td class="instruction">LD (IY+38),0</td>
<td class="comment-1" rowspan="2"><a href="23647.html">X-PTR</a> is cleared in a suitable manner and the return made.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4495"></span>04495</td>
<td class="instruction">RET</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="4264.html">04264</a>
</td>
<td class="up">Up: <a href="../maps/all.html#4381">Map</a></td>
<td class="next">
Next: <a href="4496.html">04496</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Spectrum ROM Disassembly 20191113</div>
<div class="copyright">&#169; 1982 Amstrad. &#169; 1983 Dr Ian Logan &amp; Dr Frank O'Hara. &#169; 2019 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.0.</div>
<div><a href="../../asm/111D.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>