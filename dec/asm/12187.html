<!DOCTYPE html>
<html>
<head>
<title>Spectrum ROM: Routine at 12187</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Spectrum ROM" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="12171.html">12171</a>
</td>
<td class="up">Up: <a href="../maps/all.html#12187">Map</a></td>
<td class="next">
Next: <a href="12218.html">12218</a>
</td>
</tr>
</table>
<div class="description">12187: THE 'PREPARE TO ADD' SUBROUTINE</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="12308.html">addition</a>.
</div>
<div class="paragraph">
This subroutine is the first of four subroutines that are used by the main arithmetic operation routines - <a href="12303.html">subtract</a>, <a href="12308.html">addition</a>, <a href="12490.html">multiply</a> and <a href="12719.html">division</a>.
</div>
<div class="paragraph">
This particular subroutine prepares a floating-point number for addition, mainly by replacing the sign bit with a true numerical bit 1, and negating the number (two's complement) if it is negative. The exponent is returned in the <span class="register">A</span> register and the first byte is set to 0 for a positive number and 255 for a negative number.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">HL</td>
<td class="register-desc">Address of the first byte of the number</td>
</tr>
</table>
<table class="output">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>
<tr>
<td class="register">A</td>
<td class="register-desc">Exponent byte</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="asm-label">PREP_ADD</td>
<td class="address-2"><span id="12187"></span>12187</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Transfer the exponent to <span class="register">A</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="12188"></span>12188</td>
<td class="instruction">LD (HL),0</td>
<td class="comment-1" rowspan="1">Presume a positive number.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="12190"></span>12190</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="2">If the number is zero then the preparation is already finished.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="12191"></span>12191</td>
<td class="instruction">RET Z</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="12192"></span>12192</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Now point to the sign byte.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="12193"></span>12193</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-1" rowspan="1">Set the zero flag for positive number.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="12195"></span>12195</td>
<td class="instruction">SET 7,(HL)</td>
<td class="comment-1" rowspan="1">Restore the true numeric bit.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="12197"></span>12197</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="1">Point to the first byte again.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="12198"></span>12198</td>
<td class="instruction">RET Z</td>
<td class="comment-1" rowspan="1">Positive numbers have been prepared, but negative numbers need to be two's complemented.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="12199"></span>12199</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Save any earlier exponent.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="12200"></span>12200</td>
<td class="instruction">LD BC,5</td>
<td class="comment-1" rowspan="1">There are 5 bytes to be handled.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="12203"></span>12203</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-1" rowspan="1">Point one past the last byte.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="12204"></span>12204</td>
<td class="instruction">LD B,C</td>
<td class="comment-1" rowspan="1">Transfer the 5 to <span class="register">B</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="12205"></span>12205</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">Save the exponent in <span class="register">C</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="12206"></span>12206</td>
<td class="instruction">SCF</td>
<td class="comment-1" rowspan="1">Set carry flag for negation.</td>
</tr>
<tr>
<td class="asm-label">NEG_BYTE</td>
<td class="address-2"><span id="12207"></span>12207</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="1">Point to each byte in turn.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="12208"></span>12208</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Get each byte.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="12209"></span>12209</td>
<td class="instruction">CPL</td>
<td class="comment-1" rowspan="1">One's complement the byte.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="12210"></span>12210</td>
<td class="instruction">ADC A,0</td>
<td class="comment-1" rowspan="1">Add in carry for negation.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="12212"></span>12212</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">Restore the byte.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="12213"></span>12213</td>
<td class="instruction">DJNZ <a href="12187.html#12207">NEG_BYTE</a></td>
<td class="comment-1" rowspan="1">Loop 5 times.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="12215"></span>12215</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="1">Restore the exponent to <span class="register">A</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="12216"></span>12216</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore any earlier exponent.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="12217"></span>12217</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Finished.</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="12171.html">12171</a>
</td>
<td class="up">Up: <a href="../maps/all.html#12187">Map</a></td>
<td class="next">
Next: <a href="12218.html">12218</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Spectrum ROM Disassembly 20200807</div>
<div class="copyright">&#169; 1982 Amstrad. &#169; 1983 Dr Ian Logan &amp; Dr Frank O'Hara. &#169; 2020 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
<div><a href="../../asm/2F9B.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>