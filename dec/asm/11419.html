<!DOCTYPE html>
<html>
<head>
<title>Spectrum ROM: Routine at 11419</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Spectrum ROM" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="11405.html">11405</a>
</td>
<td class="up">Up: <a href="../maps/all.html#11419">Map</a></td>
<td class="next">
Next: <a href="11547.html">11547</a>
</td>
</tr>
</table>
<div class="description">11419: THE 'DECIMAL TO FLOATING POINT' SUBROUTINE</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="9869.html">S_DECIMAL</a>.
</div>
<div class="paragraph">
As part of syntax checking decimal numbers that occur in a BASIC line are converted to their floating-point forms. This subroutine reads the decimal number digit by digit and gives its result as a 'last value' on the calculator stack. But first it deals with the alternative notation BIN, which introduces a sequence of 0's and 1's giving the binary representation of the required number.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">A</td>
<td class="register-desc">Code of the first character in the number</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="asm-label">DEC_TO_FP</td>
<td class="address-2"><span id="11419"></span>11419</td>
<td class="instruction">CP 196</td>
<td class="comment-1" rowspan="1">Is the character a 'BIN'?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11421"></span>11421</td>
<td class="instruction">JR NZ,<a href="11419.html#11448">NOT_BIN</a></td>
<td class="comment-1" rowspan="1">Jump if it is not 'BIN'.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11423"></span>11423</td>
<td class="instruction">LD DE,0</td>
<td class="comment-1" rowspan="1">Initialise result to zero in <span class="register">DE</span>.</td>
</tr>
<tr>
<td class="asm-label">BIN_DIGIT</td>
<td class="address-2"><span id="11426"></span>11426</td>
<td class="instruction">RST <a href="32.html">32</a></td>
<td class="comment-1" rowspan="1">Get the next character.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11427"></span>11427</td>
<td class="instruction">SUB "1"</td>
<td class="comment-1" rowspan="1">Subtract the character code for '1'.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11429"></span>11429</td>
<td class="instruction">ADC A,0</td>
<td class="comment-1" rowspan="1">0 now gives 0 with carry set; 1 gives 0 with carry reset.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11431"></span>11431</td>
<td class="instruction">JR NZ,<a href="11419.html#11443">BIN_END</a></td>
<td class="comment-1" rowspan="1">Any other character causes a jump to <a href="11419.html#11443">BIN_END</a> and will be checked for syntax during or after scanning.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11433"></span>11433</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Result so far to <span class="register">HL</span> now.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11434"></span>11434</td>
<td class="instruction">CCF</td>
<td class="comment-1" rowspan="1">Complement the carry flag.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11435"></span>11435</td>
<td class="instruction">ADC HL,HL</td>
<td class="comment-1" rowspan="1">Shift the result left, with the carry going to bit 0.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11437"></span>11437</td>
<td class="instruction">JP C,<a href="12490.html#12717">REPORT_6</a></td>
<td class="comment-1" rowspan="1">Report overflow if more than 65535.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11440"></span>11440</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Return the result so far to <span class="register">DE</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11441"></span>11441</td>
<td class="instruction">JR <a href="11419.html#11426">BIN_DIGIT</a></td>
<td class="comment-1" rowspan="1">Jump back for next 0 or 1.</td>
</tr>
<tr>
<td class="asm-label">BIN_END</td>
<td class="address-2"><span id="11443"></span>11443</td>
<td class="instruction">LD B,D</td>
<td class="comment-1" rowspan="2">Copy result to <span class="register">BC</span> for stacking.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11444"></span>11444</td>
<td class="instruction">LD C,E</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11445"></span>11445</td>
<td class="instruction">JP <a href="11563.html">STACK_BC</a></td>
<td class="comment-1" rowspan="1">Jump forward to stack the result.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="11448"></span>
<div class="comments">
<div class="paragraph">
For other numbers, first any integer part is converted; if the next character is a decimal, then the decimal fraction is considered.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">NOT_BIN</td>
<td class="address-2"><span id="11448"></span>11448</td>
<td class="instruction">CP "."</td>
<td class="comment-1" rowspan="1">Is the first character a '.'?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11450"></span>11450</td>
<td class="instruction">JR Z,<a href="11419.html#11467">DECIMAL</a></td>
<td class="comment-1" rowspan="1">If so, jump forward.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11452"></span>11452</td>
<td class="instruction">CALL <a href="11579.html">INT_TO_FP</a></td>
<td class="comment-1" rowspan="1">Otherwise, form a 'last value' of the integer.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11455"></span>11455</td>
<td class="instruction">CP "."</td>
<td class="comment-1" rowspan="1">Is the next character a '.'?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11457"></span>11457</td>
<td class="instruction">JR NZ,<a href="11419.html#11499">E_FORMAT</a></td>
<td class="comment-1" rowspan="1">Jump forward to see if it is an 'E'.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11459"></span>11459</td>
<td class="instruction">RST <a href="32.html">32</a></td>
<td class="comment-1" rowspan="1">Get the next character.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11460"></span>11460</td>
<td class="instruction">CALL <a href="11547.html">NUMERIC</a></td>
<td class="comment-1" rowspan="1">Is it a digit?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11463"></span>11463</td>
<td class="instruction">JR C,<a href="11419.html#11499">E_FORMAT</a></td>
<td class="comment-1" rowspan="1">Jump if not (e.g. 1.E4 is allowed).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11465"></span>11465</td>
<td class="instruction">JR <a href="11419.html#11477">DEC_STO_1</a></td>
<td class="comment-1" rowspan="1">Jump forward to deal with the digits after the decimal point.</td>
</tr>
<tr>
<td class="asm-label">DECIMAL</td>
<td class="address-2"><span id="11467"></span>11467</td>
<td class="instruction">RST <a href="32.html">32</a></td>
<td class="comment-1" rowspan="2">If the number started with a decimal, see if the next character is a digit.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11468"></span>11468</td>
<td class="instruction">CALL <a href="11547.html">NUMERIC</a></td>
</tr>
<tr>
<td class="asm-label">DEC_RPT_C</td>
<td class="address-2"><span id="11471"></span>11471</td>
<td class="instruction">JP C,<a href="7289.html#7306">REPORT_C</a></td>
<td class="comment-1" rowspan="1">Report the error if it is not.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11474"></span>11474</td>
<td class="instruction">RST <a href="40.html">40</a></td>
<td class="comment-1" rowspan="1">Use the calculator to stack zero as the integer part of such numbers.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11475"></span>11475</td>
<td class="instruction">DEFB 160</td>
<td class="comment-1" rowspan="1"><a href="13339.html">stk_zero</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11476"></span>11476</td>
<td class="instruction">DEFB 56</td>
<td class="comment-1" rowspan="1"><a href="13979.html">end_calc</a></td>
</tr>
<tr>
<td class="asm-label">DEC_STO_1</td>
<td class="address-2"><span id="11477"></span>11477</td>
<td class="instruction">RST <a href="40.html">40</a></td>
<td class="comment-1" rowspan="1">Use the calculator to copy the number 1 to mem-0.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11478"></span>11478</td>
<td class="instruction">DEFB 161</td>
<td class="comment-1" rowspan="1"><a href="13339.html">stk_one</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11479"></span>11479</td>
<td class="instruction">DEFB 192</td>
<td class="comment-1" rowspan="1"><a href="13357.html">st_mem_0</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11480"></span>11480</td>
<td class="instruction">DEFB 2</td>
<td class="comment-1" rowspan="1"><a href="13147.html#13217">delete</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11481"></span>11481</td>
<td class="instruction">DEFB 56</td>
<td class="comment-1" rowspan="1"><a href="13979.html">end_calc</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="11482"></span>
<div class="comments">
<div class="paragraph">
For each passage of the following loop, the number (N) saved in the memory area mem-0 is fetched, divided by 10 and restored, i.e. N goes from 1 to .1 to .01 to .001 etc. The present digit (D) is multiplied by N/10 and added to the 'last value' (V), giving V+D*N/10.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">NXT_DGT_1</td>
<td class="address-2"><span id="11482"></span>11482</td>
<td class="instruction">RST <a href="24.html">24</a></td>
<td class="comment-1" rowspan="1">Get the present character.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11483"></span>11483</td>
<td class="instruction">CALL <a href="11554.html">STK_DIGIT</a></td>
<td class="comment-1" rowspan="1">If it is a digit (D) then stack it.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11486"></span>11486</td>
<td class="instruction">JR C,<a href="11419.html#11499">E_FORMAT</a></td>
<td class="comment-1" rowspan="1">If not jump forward.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11488"></span>11488</td>
<td class="instruction">RST <a href="40.html">40</a></td>
<td class="comment-1" rowspan="1">Now use the calculator.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11489"></span>11489</td>
<td class="instruction">DEFB 224</td>
<td class="comment-1" rowspan="1"><a href="13327.html">get_mem_0</a>: V, D, N</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11490"></span>11490</td>
<td class="instruction">DEFB 164</td>
<td class="comment-1" rowspan="1"><a href="13339.html">stk_ten</a>: V, D, N, 10</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11491"></span>11491</td>
<td class="instruction">DEFB 5</td>
<td class="comment-1" rowspan="1"><a href="12719.html">division</a>: V, D, N/10</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11492"></span>11492</td>
<td class="instruction">DEFB 192</td>
<td class="comment-1" rowspan="1"><a href="13357.html">st_mem_0</a>: V, D, N/10 (N/10 is copied to mem-0)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11493"></span>11493</td>
<td class="instruction">DEFB 4</td>
<td class="comment-1" rowspan="1"><a href="12490.html">multiply</a>: V, D*N/10</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11494"></span>11494</td>
<td class="instruction">DEFB 15</td>
<td class="comment-1" rowspan="1"><a href="12308.html">addition</a>: V+D*N/10</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11495"></span>11495</td>
<td class="instruction">DEFB 56</td>
<td class="comment-1" rowspan="1"><a href="13979.html">end_calc</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11496"></span>11496</td>
<td class="instruction">RST <a href="32.html">32</a></td>
<td class="comment-1" rowspan="1">Get the next character.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11497"></span>11497</td>
<td class="instruction">JR <a href="11419.html#11482">NXT_DGT_1</a></td>
<td class="comment-1" rowspan="1">Jump back (one more byte than needed) to consider it.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="11499"></span>
<div class="comments">
<div class="paragraph">
Next consider any 'E notation', i.e. the form xEm or xem where m is a positive or negative integer.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">E_FORMAT</td>
<td class="address-2"><span id="11499"></span>11499</td>
<td class="instruction">CP "E"</td>
<td class="comment-1" rowspan="1">Is the present character an 'E'?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11501"></span>11501</td>
<td class="instruction">JR Z,<a href="11419.html#11506">SIGN_FLAG</a></td>
<td class="comment-1" rowspan="1">Jump forward if it is.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11503"></span>11503</td>
<td class="instruction">CP "e"</td>
<td class="comment-1" rowspan="1">Is it an 'e'?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11505"></span>11505</td>
<td class="instruction">RET NZ</td>
<td class="comment-1" rowspan="1">Finished unless it is so.</td>
</tr>
<tr>
<td class="asm-label">SIGN_FLAG</td>
<td class="address-2"><span id="11506"></span>11506</td>
<td class="instruction">LD B,255</td>
<td class="comment-1" rowspan="1">Use <span class="register">B</span> as a sign flag, 255 for '+'.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11508"></span>11508</td>
<td class="instruction">RST <a href="32.html">32</a></td>
<td class="comment-1" rowspan="1">Get the next character.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11509"></span>11509</td>
<td class="instruction">CP "+"</td>
<td class="comment-1" rowspan="1">Is it a '+'?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11511"></span>11511</td>
<td class="instruction">JR Z,<a href="11419.html#11518">SIGN_DONE</a></td>
<td class="comment-1" rowspan="1">Jump forward.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11513"></span>11513</td>
<td class="instruction">CP "-"</td>
<td class="comment-1" rowspan="1">Is it a '-'?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11515"></span>11515</td>
<td class="instruction">JR NZ,<a href="11419.html#11519">ST_E_PART</a></td>
<td class="comment-1" rowspan="1">Jump if neither '+' nor '-'.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11517"></span>11517</td>
<td class="instruction">INC B</td>
<td class="comment-1" rowspan="1">Change the sign of the flag.</td>
</tr>
<tr>
<td class="asm-label">SIGN_DONE</td>
<td class="address-2"><span id="11518"></span>11518</td>
<td class="instruction">RST <a href="32.html">32</a></td>
<td class="comment-1" rowspan="1">Point to the first digit.</td>
</tr>
<tr>
<td class="asm-label">ST_E_PART</td>
<td class="address-2"><span id="11519"></span>11519</td>
<td class="instruction">CALL <a href="11547.html">NUMERIC</a></td>
<td class="comment-1" rowspan="1">Is it indeed a digit?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11522"></span>11522</td>
<td class="instruction">JR C,<a href="11419.html#11471">DEC_RPT_C</a></td>
<td class="comment-1" rowspan="1">Report the error if not.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11524"></span>11524</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Save the flag in <span class="register">B</span> briefly.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11525"></span>11525</td>
<td class="instruction">CALL <a href="11579.html">INT_TO_FP</a></td>
<td class="comment-1" rowspan="1">Stack ABS m, where m is the exponent.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11528"></span>11528</td>
<td class="instruction">CALL <a href="11733.html">FP_TO_A</a></td>
<td class="comment-1" rowspan="1">Transfer ABS m to <span class="register">A</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11531"></span>11531</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore the sign flag to <span class="register">B</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11532"></span>11532</td>
<td class="instruction">JP C,<a href="12490.html#12717">REPORT_6</a></td>
<td class="comment-1" rowspan="3">Report the overflow now if ABS m is greater than 255 or indeed greater than 127 (other values greater than about 39 will be detected later).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11535"></span>11535</td>
<td class="instruction">AND A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11536"></span>11536</td>
<td class="instruction">JP M,<a href="12490.html#12717">REPORT_6</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11539"></span>11539</td>
<td class="instruction">INC B</td>
<td class="comment-1" rowspan="1">Test the sign flag in <span class="register">B</span>; '+' (i.e. 255) will now set the zero flag.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11540"></span>11540</td>
<td class="instruction">JR Z,<a href="11419.html#11544">E_FP_JUMP</a></td>
<td class="comment-1" rowspan="1">Jump if sign of m is '+'.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11542"></span>11542</td>
<td class="instruction">NEG</td>
<td class="comment-1" rowspan="1">Negate m if sign is '-'.</td>
</tr>
<tr>
<td class="asm-label">E_FP_JUMP</td>
<td class="address-2"><span id="11544"></span>11544</td>
<td class="instruction">JP <a href="11599.html">e_to_fp</a></td>
<td class="comment-1" rowspan="1">Jump to assign to the 'last value' the result of x*10&#8593;m.</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="11405.html">11405</a>
</td>
<td class="up">Up: <a href="../maps/all.html#11419">Map</a></td>
<td class="next">
Next: <a href="11547.html">11547</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Spectrum ROM Disassembly 20221121</div>
<div class="copyright">&#169; 1982 Amstrad. &#169; 1983 Dr Ian Logan &amp; Dr Frank O'Hara. &#169; 2022 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.8.</div>
<div><a href="../../asm/2C9B.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>