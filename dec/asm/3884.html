<!DOCTYPE html>
<html>
<head>
<title>Spectrum ROM: Routine at 03884</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Spectrum ROM" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="3828.html">03828</a>
</td>
<td class="up">Up: <a href="../maps/all.html#3884">Map</a></td>
<td class="next">
Next: <a href="4000.html">04000</a>
</td>
</tr>
</table>
<div class="description">03884: THE 'EDITOR' ROUTINES</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="4770.html">MAIN_EXEC</a> and <a href="8329.html">INPUT</a>.
</div>
<div class="paragraph">
The editor is called on two occasions:
</div>
<div class="paragraph">
<ul class="">
<li>From the <a href="4770.html">main execution routine</a> so that the user can enter a BASIC line into the system.</li>
<li>From the <a href="8329.html">INPUT command routine</a>.</li>
</ul>
</div>
<div class="paragraph">
First the 'error stack pointer' is saved and an alternative address provided.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">EDITOR</td>
<td class="address-2"><span id="3884"></span>03884</td>
<td class="instruction">LD HL,(23613)</td>
<td class="comment-1" rowspan="2">The current value of <a href="23613.html">ERR-SP</a> is saved on the machine stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3887"></span>03887</td>
<td class="instruction">PUSH HL</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="3888"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="4223.html">ED_ERROR</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ED_AGAIN</td>
<td class="address-2"><span id="3888"></span>03888</td>
<td class="instruction">LD HL,4223</td>
<td class="comment-1" rowspan="1">This is <a href="4223.html">ED_ERROR</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3891"></span>03891</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="2">Any event that leads to the error handling routine (see <a href="23613.html">ERR-SP</a>) being used will come back to <a href="4223.html">ED_ERROR</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3892"></span>03892</td>
<td class="instruction">LD (23613),SP</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="3896"></span>
<div class="comments">
<div class="paragraph">
A loop is now entered to handle each keystroke.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ED_LOOP</td>
<td class="address-1"><span id="3896"></span>03896</td>
<td class="instruction">CALL <a href="5588.html">WAIT_KEY</a></td>
<td class="comment-1" rowspan="1">Return once a key has been pressed.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3899"></span>03899</td>
<td class="instruction">PUSH AF</td>
<td class="comment-1" rowspan="1">Save the code temporarily.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3900"></span>03900</td>
<td class="instruction">LD D,0</td>
<td class="comment-1" rowspan="2">Fetch the duration of the keyboard click (<a href="23609.html">PIP</a>).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3902"></span>03902</td>
<td class="instruction">LD E,(IY-1)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3905"></span>03905</td>
<td class="instruction">LD HL,200</td>
<td class="comment-1" rowspan="1">And the pitch.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3908"></span>03908</td>
<td class="instruction">CALL <a href="949.html">BEEPER</a></td>
<td class="comment-1" rowspan="1">Now make the 'pip'.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3911"></span>03911</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="1">Restore the code.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3912"></span>03912</td>
<td class="instruction">LD HL,3896</td>
<td class="comment-1" rowspan="2">Pre-load the machine stack with the address of <a href="3884.html#3896">ED_LOOP</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3915"></span>03915</td>
<td class="instruction">PUSH HL</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="3916"></span>
<div class="comments">
<div class="paragraph">
Now analyse the code obtained.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3916"></span>03916</td>
<td class="instruction">CP 24</td>
<td class="comment-1" rowspan="2">Accept all character codes, graphic codes and tokens.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3918"></span>03918</td>
<td class="instruction">JR NC,<a href="3884.html#3969">ADD_CHAR</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3920"></span>03920</td>
<td class="instruction">CP 7</td>
<td class="comment-1" rowspan="2">Also accept ','.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3922"></span>03922</td>
<td class="instruction">JR C,<a href="3884.html#3969">ADD_CHAR</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3924"></span>03924</td>
<td class="instruction">CP 16</td>
<td class="comment-1" rowspan="2">Jump forward if the code represents an editing key.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3926"></span>03926</td>
<td class="instruction">JR C,<a href="3884.html#3986">ED_KEYS</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="3928"></span>
<div class="comments">
<div class="paragraph">
The control keys - INK to TAB - are now considered.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3928"></span>03928</td>
<td class="instruction">LD BC,2</td>
<td class="comment-1" rowspan="1">INK and PAPER will require two locations.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3931"></span>03931</td>
<td class="instruction">LD D,A</td>
<td class="comment-1" rowspan="1">Copy the code to <span class="register">D</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3932"></span>03932</td>
<td class="instruction">CP 22</td>
<td class="comment-1" rowspan="2">Jump forward with INK and PAPER.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3934"></span>03934</td>
<td class="instruction">JR C,<a href="3884.html#3948">ED_CONTR</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="3936"></span>
<div class="comments">
<div class="paragraph">
AT and TAB would be handled as follows:
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3936"></span>03936</td>
<td class="instruction">INC BC</td>
<td class="comment-1" rowspan="1">Three locations required.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3937"></span>03937</td>
<td class="instruction">BIT 7,(IY+55)</td>
<td class="comment-1" rowspan="2">Jump forward unless dealing with 'INPUT LINE...' (bit 7 of <a href="23665.html">FLAGX</a> set).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3941"></span>03941</td>
<td class="instruction">JP Z,<a href="4126.html">ED_IGNORE</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3944"></span>03944</td>
<td class="instruction">CALL <a href="5588.html">WAIT_KEY</a></td>
<td class="comment-1" rowspan="2">Get the second code and put it in <span class="register">E</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3947"></span>03947</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="3948"></span>
<div class="comments">
<div class="paragraph">
The other bytes for the control characters are now fetched.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ED_CONTR</td>
<td class="address-2"><span id="3948"></span>03948</td>
<td class="instruction">CALL <a href="5588.html">WAIT_KEY</a></td>
<td class="comment-1" rowspan="1">Get another code.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3951"></span>03951</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1">Save the previous codes.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3952"></span>03952</td>
<td class="instruction">LD HL,(23643)</td>
<td class="comment-1" rowspan="1">Fetch <a href="23643.html">K-CUR</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3955"></span>03955</td>
<td class="instruction">RES 0,(IY+7)</td>
<td class="comment-1" rowspan="1">Signal 'K mode' (reset bit 0 of <a href="23617.html">MODE</a>).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3959"></span>03959</td>
<td class="instruction">CALL <a href="5714.html#5717">MAKE_ROOM</a></td>
<td class="comment-1" rowspan="1">Make two or three spaces.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3962"></span>03962</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore the previous codes.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3963"></span>03963</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Point to the first location.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3964"></span>03964</td>
<td class="instruction">LD (HL),B</td>
<td class="comment-1" rowspan="1">Enter first code.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3965"></span>03965</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="2">Then enter the second code which will be overwritten if there are only two codes - i.e. with INK and PAPER.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3966"></span>03966</td>
<td class="instruction">LD (HL),C</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3967"></span>03967</td>
<td class="instruction">JR <a href="3884.html#3979">ADD_CH_1</a></td>
<td class="comment-1" rowspan="1">Jump forward.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="3969"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="4214.html">ED_SYMBOL</a>.
</div>
<div class="paragraph">
The address of this entry point is found in the <a href="5551.html">initial channel information table</a>.
</div>
<div class="paragraph">
The following subroutine actually adds a code to the current EDIT or INPUT line.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ADD_CHAR</td>
<td class="address-2"><span id="3969"></span>03969</td>
<td class="instruction">RES 0,(IY+7)</td>
<td class="comment-1" rowspan="1">Signal 'K mode' (reset bit 0 of <a href="23617.html">MODE</a>).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3973"></span>03973</td>
<td class="instruction">LD HL,(23643)</td>
<td class="comment-1" rowspan="1">Fetch the cursor position (<a href="23643.html">K-CUR</a>).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3976"></span>03976</td>
<td class="instruction">CALL <a href="5714.html">ONE_SPACE</a></td>
<td class="comment-1" rowspan="1">Make a single space.</td>
</tr>
<tr>
<td class="asm-label">ADD_CH_1</td>
<td class="address-2"><span id="3979"></span>03979</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-1" rowspan="4">Enter the code into the space and set <a href="23643.html">K-CUR</a> to signal that the cursor is to occur at the location after. Then return indirectly to <a href="3884.html#3896">ED_LOOP</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3980"></span>03980</td>
<td class="instruction">INC DE</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3981"></span>03981</td>
<td class="instruction">LD (23643),DE</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3985"></span>03985</td>
<td class="instruction">RET</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="3986"></span>
<div class="comments">
<div class="paragraph">
The editing keys are dealt with as follows:
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ED_KEYS</td>
<td class="address-2"><span id="3986"></span>03986</td>
<td class="instruction">LD E,A</td>
<td class="comment-1" rowspan="2">The code is transferred to the <span class="register">DE</span> register pair.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3987"></span>03987</td>
<td class="instruction">LD D,0</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3989"></span>03989</td>
<td class="instruction">LD HL,3993</td>
<td class="comment-1" rowspan="1">The base address of the <a href="4000.html">editing keys table</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3992"></span>03992</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-1" rowspan="2">The entry is addressed and then fetched into <span class="register">E</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3993"></span>03993</td>
<td class="instruction">LD E,(HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3994"></span>03994</td>
<td class="instruction">ADD HL,DE</td>
<td class="comment-1" rowspan="2">The address of the handling routine is saved on the machine stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3995"></span>03995</td>
<td class="instruction">PUSH HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3996"></span>03996</td>
<td class="instruction">LD HL,(23643)</td>
<td class="comment-1" rowspan="2">The <span class="register">HL</span> register pair is set to <a href="23643.html">K-CUR</a> and an indirect jump made to the required routine.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3999"></span>03999</td>
<td class="instruction">RET</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="3828.html">03828</a>
</td>
<td class="up">Up: <a href="../maps/all.html#3884">Map</a></td>
<td class="next">
Next: <a href="4000.html">04000</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Spectrum ROM Disassembly 20200807</div>
<div class="copyright">&#169; 1982 Amstrad. &#169; 1983 Dr Ian Logan &amp; Dr Frank O'Hara. &#169; 2020 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
<div><a href="../../asm/0F2C.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>