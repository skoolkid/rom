<!DOCTYPE html>
<html>
<head>
<title>Spectrum ROM: Routine at 01016</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Spectrum ROM" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="949.html">00949</a>
</td>
<td class="up">Up: <a href="../maps/all.html#1016">Map</a></td>
<td class="next">
Next: <a href="1134.html">01134</a>
</td>
</tr>
</table>
<div class="description">01016: THE 'BEEP' COMMAND ROUTINE</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
The address of this routine is found in the <a href="6728.html#6883">parameter table</a>.
</div>
<div class="paragraph">
The subroutine is entered with two numbers on the calculator stack. The topmost number (P) represents the 'pitch' of the note and the number underneath it (t) represents the 'duration'.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">BEEP</td>
<td class="address-2"><span id="1016"></span>01016</td>
<td class="instruction">RST <a href="40.html">40</a></td>
<td class="comment-1" rowspan="1">The floating-point calculator is used to manipulate the two values: t, P.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1017"></span>01017</td>
<td class="instruction">DEFB 49</td>
<td class="comment-1" rowspan="1"><a href="13248.html">duplicate</a>: t, P, P</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1018"></span>01018</td>
<td class="instruction">DEFB 39</td>
<td class="comment-1" rowspan="1"><a href="13999.html">int</a>: t, P, i (where i=INT P)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1019"></span>01019</td>
<td class="instruction">DEFB 192</td>
<td class="comment-1" rowspan="1"><a href="13357.html">st_mem_0</a>: t, P, i (mem-0 holds i)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1020"></span>01020</td>
<td class="instruction">DEFB 3</td>
<td class="comment-1" rowspan="1"><a href="12303.html">subtract</a>: t, p (where p is the fractional part of P)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1021"></span>01021</td>
<td class="instruction">DEFB 52</td>
<td class="comment-1" rowspan="2"><a href="13254.html">stk_data</a>: Stack the decimal value K=0.0577622606 (which is a little below 12*(2&#8593;0.5)-1)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1022"></span>01022</td>
<td class="instruction">DEFB 236,108,152,31,245</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1027"></span>01027</td>
<td class="instruction">DEFB 4</td>
<td class="comment-1" rowspan="1"><a href="12490.html">multiply</a>: t, pK</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1028"></span>01028</td>
<td class="instruction">DEFB 161</td>
<td class="comment-1" rowspan="1"><a href="13339.html">stk_one</a>: t, pK, 1</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1029"></span>01029</td>
<td class="instruction">DEFB 15</td>
<td class="comment-1" rowspan="1"><a href="12308.html">addition</a>: t, pK+1</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1030"></span>01030</td>
<td class="instruction">DEFB 56</td>
<td class="comment-1" rowspan="1"><a href="13979.html">end_calc</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="1031"></span>
<div class="comments">
<div class="paragraph">
Now perform several tests on i, the integer part of the 'pitch'.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1031"></span>01031</td>
<td class="instruction">LD HL,23698</td>
<td class="comment-1" rowspan="1">This is 'mem-0-1st' (<a href="23698.html">MEMBOT</a>).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1034"></span>01034</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Fetch the exponent of i.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1035"></span>01035</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="2">Give an error if i is not in the integral (short) form.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1036"></span>01036</td>
<td class="instruction">JR NZ,<a href="1016.html#1132">REPORT_B</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1038"></span>01038</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="2">Copy the sign byte to the <span class="register">C</span> register.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1039"></span>01039</td>
<td class="instruction">LD C,(HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1040"></span>01040</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="3">Copy the low-byte to the <span class="register">B</span> register, and to the <span class="register">A</span> register.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1041"></span>01041</td>
<td class="instruction">LD B,(HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1042"></span>01042</td>
<td class="instruction">LD A,B</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1043"></span>01043</td>
<td class="instruction">RLA</td>
<td class="comment-1" rowspan="7">Again give report B if i does not satisfy the test: -128&lt;=i&lt;=+127.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1044"></span>01044</td>
<td class="instruction">SBC A,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1045"></span>01045</td>
<td class="instruction">CP C</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1046"></span>01046</td>
<td class="instruction">JR NZ,<a href="1016.html#1132">REPORT_B</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1048"></span>01048</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1049"></span>01049</td>
<td class="instruction">CP (HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1050"></span>01050</td>
<td class="instruction">JR NZ,<a href="1016.html#1132">REPORT_B</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1052"></span>01052</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="2">Fetch the low-byte and test it further.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1053"></span>01053</td>
<td class="instruction">ADD A,60</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1055"></span>01055</td>
<td class="instruction">JP P,<a href="1016.html#1061">BE_i_OK</a></td>
<td class="comment-1" rowspan="1">Accept -60&lt;=i&lt;=67.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1058"></span>01058</td>
<td class="instruction">JP PO,<a href="1016.html#1132">REPORT_B</a></td>
<td class="comment-1" rowspan="1">Reject -128 to -61.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="1061"></span>
<div class="comments">
<div class="paragraph">
Note: the range 70 to 127 will be rejected later on.
</div>
<div class="paragraph">
The correct frequency for the 'pitch' i can now be found.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">BE_i_OK</td>
<td class="address-2"><span id="1061"></span>01061</td>
<td class="instruction">LD B,250</td>
<td class="comment-1" rowspan="1">Start '6' octaves below middle C.</td>
</tr>
<tr>
<td class="asm-label">BE_OCTAVE</td>
<td class="address-2"><span id="1063"></span>01063</td>
<td class="instruction">INC B</td>
<td class="comment-1" rowspan="3">Repeatedly reduce i in order to find the correct octave.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1064"></span>01064</td>
<td class="instruction">SUB 12</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1066"></span>01066</td>
<td class="instruction">JR NC,<a href="1016.html#1063">BE_OCTAVE</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1068"></span>01068</td>
<td class="instruction">ADD A,12</td>
<td class="comment-1" rowspan="1">Add back the last subtraction.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1070"></span>01070</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Save the octave number.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1071"></span>01071</td>
<td class="instruction">LD HL,1134</td>
<td class="comment-1" rowspan="1">The base address of the '<a href="1134.html">semitone table</a>'.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1074"></span>01074</td>
<td class="instruction">CALL <a href="13318.html">LOC_MEM</a></td>
<td class="comment-1" rowspan="2">Consider the table and pass the 'A th.' value to the calculator stack. (Call it C.)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1077"></span>01077</td>
<td class="instruction">CALL <a href="13236.html">STACK_NUM</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="1080"></span>
<div class="comments">
<div class="paragraph">
Now the fractional part of the 'pitch' can be taken into consideration.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1080"></span>01080</td>
<td class="instruction">RST <a href="40.html">40</a></td>
<td class="comment-1" rowspan="1">t, pK+1, C</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1081"></span>01081</td>
<td class="instruction">DEFB 4</td>
<td class="comment-1" rowspan="1"><a href="12490.html">multiply</a>: t, C(pK+1)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1082"></span>01082</td>
<td class="instruction">DEFB 56</td>
<td class="comment-1" rowspan="1"><a href="13979.html">end_calc</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="1083"></span>
<div class="comments">
<div class="paragraph">
The final frequency f is found by modifying the 'last value' according to the octave number.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1083"></span>01083</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="1">Fetch the octave number.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1084"></span>01084</td>
<td class="instruction">ADD A,(HL)</td>
<td class="comment-1" rowspan="2">Multiply the 'last value' by 2 to the power of the octave number.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1085"></span>01085</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1086"></span>01086</td>
<td class="instruction">RST <a href="40.html">40</a></td>
<td class="comment-1" rowspan="1">t, f</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1087"></span>01087</td>
<td class="instruction">DEFB 192</td>
<td class="comment-1" rowspan="1"><a href="13357.html">st_mem_0</a>: Copy the frequency (f) to mem-0</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1088"></span>01088</td>
<td class="instruction">DEFB 2</td>
<td class="comment-1" rowspan="1"><a href="13147.html#13217">delete</a>: t</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="1089"></span>
<div class="comments">
<div class="paragraph">
Attention is now turned to the 'duration'.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1089"></span>01089</td>
<td class="instruction">DEFB 49</td>
<td class="comment-1" rowspan="1"><a href="13248.html">duplicate</a>: t, t</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1090"></span>01090</td>
<td class="instruction">DEFB 56</td>
<td class="comment-1" rowspan="1"><a href="13979.html">end_calc</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1091"></span>01091</td>
<td class="instruction">CALL <a href="7828.html">FIND_INT1</a></td>
<td class="comment-1" rowspan="3">The value 'INT t' must be in the range 0 to 10.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1094"></span>01094</td>
<td class="instruction">CP 11</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1096"></span>01096</td>
<td class="instruction">JR NC,<a href="1016.html#1132">REPORT_B</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="1098"></span>
<div class="comments">
<div class="paragraph">
The number of complete cycles in the 'beep' is given by f*t so this value is now found.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1098"></span>01098</td>
<td class="instruction">RST <a href="40.html">40</a></td>
<td class="comment-1" rowspan="1">t</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1099"></span>01099</td>
<td class="instruction">DEFB 224</td>
<td class="comment-1" rowspan="1"><a href="13327.html">get_mem_0</a>: t, f</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1100"></span>01100</td>
<td class="instruction">DEFB 4</td>
<td class="comment-1" rowspan="1"><a href="12490.html">multiply</a>: f*t</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="1101"></span>
<div class="comments">
<div class="paragraph">
The result is left on the calculator stack whilst the length of the 'timing loop' required for the 'beep' is computed.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1101"></span>01101</td>
<td class="instruction">DEFB 224</td>
<td class="comment-1" rowspan="1"><a href="13327.html">get_mem_0</a>: f*t, f</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1102"></span>01102</td>
<td class="instruction">DEFB 52</td>
<td class="comment-1" rowspan="2"><a href="13254.html">stk_data</a>: Stack the value (3.5*10&#8593;6)/8=437500</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1103"></span>01103</td>
<td class="instruction">DEFB 128,67,85,159,128</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1108"></span>01108</td>
<td class="instruction">DEFB 1</td>
<td class="comment-1" rowspan="1"><a href="13372.html">exchange</a>: f*t, 437500, f</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1109"></span>01109</td>
<td class="instruction">DEFB 5</td>
<td class="comment-1" rowspan="1"><a href="12719.html">division</a>: f*t, 437500/f</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1110"></span>01110</td>
<td class="instruction">DEFB 52</td>
<td class="comment-1" rowspan="2"><a href="13254.html">stk_data</a>: f*t, 437500/f, 30.125</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1111"></span>01111</td>
<td class="instruction">DEFB 53,113</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1113"></span>01113</td>
<td class="instruction">DEFB 3</td>
<td class="comment-1" rowspan="1"><a href="12303.html">subtract</a>: f*t, 437500/f-30.125</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1114"></span>01114</td>
<td class="instruction">DEFB 56</td>
<td class="comment-1" rowspan="1"><a href="13979.html">end_calc</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="1115"></span>
<div class="comments">
<div class="paragraph">
Note: the value 437500/f gives the 'half-cycle' length of the note and reducing it by 30.125 allows for 120.5 T states in which to actually produce the note and adjust the counters etc.
</div>
<div class="paragraph">
The values can now be transferred to the required registers.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1115"></span>01115</td>
<td class="instruction">CALL <a href="7828.html#7833">FIND_INT2</a></td>
<td class="comment-1" rowspan="2">The 'timing loop' value is compressed into the <span class="register">BC</span> register pair and saved.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1118"></span>01118</td>
<td class="instruction">PUSH BC</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="1119"></span>
<div class="comments">
<div class="paragraph">
Note: if the timing loop value is too large then an error will occur (returning via <a href="8.html">ERROR_1</a>), thereby excluding 'pitch' values of 70 to 127.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1119"></span>01119</td>
<td class="instruction">CALL <a href="7828.html#7833">FIND_INT2</a></td>
<td class="comment-1" rowspan="1">The f*t value is compressed into the <span class="register">BC</span> register pair.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1122"></span>01122</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Move the 'timing loop' value to the <span class="register">HL</span> register pair.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1123"></span>01123</td>
<td class="instruction">LD D,B</td>
<td class="comment-1" rowspan="2">Move the f*t value to the <span class="register">DE</span> register pair.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1124"></span>01124</td>
<td class="instruction">LD E,C</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="1125"></span>
<div class="comments">
<div class="paragraph">
However before making the 'beep' test the value f*t.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1125"></span>01125</td>
<td class="instruction">LD A,D</td>
<td class="comment-1" rowspan="3">Return if f*t has given the result of 'no cycles' required.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1126"></span>01126</td>
<td class="instruction">OR E</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1127"></span>01127</td>
<td class="instruction">RET Z</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1128"></span>01128</td>
<td class="instruction">DEC DE</td>
<td class="comment-1" rowspan="2">Decrease the cycle number and jump to <a href="949.html">BEEPER</a> (making at least one pass).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1129"></span>01129</td>
<td class="instruction">JP <a href="949.html">BEEPER</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="1132"></span>
<div class="comments">
<div class="paragraph">
Report B - integer out of range.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">REPORT_B</td>
<td class="address-2"><span id="1132"></span>01132</td>
<td class="instruction">RST <a href="8.html">8</a></td>
<td class="comment-1" rowspan="2">Call the error handling routine.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1133"></span>01133</td>
<td class="instruction">DEFB 10</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="949.html">00949</a>
</td>
<td class="up">Up: <a href="../maps/all.html#1016">Map</a></td>
<td class="next">
Next: <a href="1134.html">01134</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Spectrum ROM Disassembly 20200807</div>
<div class="copyright">&#169; 1982 Amstrad. &#169; 1983 Dr Ian Logan &amp; Dr Frank O'Hara. &#169; 2020 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
<div><a href="../../asm/03F8.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>