<!DOCTYPE html>
<html>
<head>
<title>Spectrum ROM: Routine at 11266</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Spectrum ROM" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="11249.html">11249</a>
</td>
<td class="up">Up: <a href="../maps/all.html#11266">Map</a></td>
<td class="next">
Next: <a href="11400.html">11400</a>
</td>
</tr>
</table>
<div class="description">11266: THE 'DIM' COMMAND ROUTINE</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
The address of this routine is found in the <a href="6728.html#6818">parameter table</a>.
</div>
<div class="paragraph">
This routine establishes new arrays in the variables area. The routine starts by searching the existing variables area to determine whether there is an existing array with the same name. If such an array is found then it is 'reclaimed' before the new array is established.
</div>
<div class="paragraph">
A new array will have all its elements set to zero if it is a numeric array, or to 'spaces' if it is an array of strings.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">DIM</td>
<td class="address-2"><span id="11266"></span>11266</td>
<td class="instruction">CALL <a href="10418.html">LOOK_VARS</a></td>
<td class="comment-1" rowspan="1">Search the variables area.</td>
</tr>
<tr>
<td class="asm-label">D_RPORT_C</td>
<td class="address-2"><span id="11269"></span>11269</td>
<td class="instruction">JP NZ,<a href="7289.html#7306">REPORT_C</a></td>
<td class="comment-1" rowspan="1">Give report C as there has been an error.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11272"></span>11272</td>
<td class="instruction">CALL <a href="9520.html">SYNTAX_Z</a></td>
<td class="comment-1" rowspan="2">Jump forward if in 'run time'.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11275"></span>11275</td>
<td class="instruction">JR NZ,<a href="11266.html#11285">D_RUN</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11277"></span>11277</td>
<td class="instruction">RES 6,C</td>
<td class="comment-1" rowspan="1">Test the syntax for string arrays as if they were numeric.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11279"></span>11279</td>
<td class="instruction">CALL <a href="10646.html">STK_VAR</a></td>
<td class="comment-1" rowspan="1">Check the syntax of the parenthesised expression.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11282"></span>11282</td>
<td class="instruction">CALL <a href="7150.html">CHECK_END</a></td>
<td class="comment-1" rowspan="1">Move on to consider the next statement as the syntax was satisfactory.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="11285"></span>
<div class="comments">
<div class="paragraph">
An 'existing array' is reclaimed.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">D_RUN</td>
<td class="address-2"><span id="11285"></span>11285</td>
<td class="instruction">JR C,<a href="11266.html#11295">D_LETTER</a></td>
<td class="comment-1" rowspan="1">Jump forward if there is no 'existing array'.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11287"></span>11287</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Save the discriminator byte.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11288"></span>11288</td>
<td class="instruction">CALL <a href="6584.html">NEXT_ONE</a></td>
<td class="comment-1" rowspan="1">Find the start of the next variable.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11291"></span>11291</td>
<td class="instruction">CALL <a href="6629.html#6632">RECLAIM_2</a></td>
<td class="comment-1" rowspan="1">Reclaim the 'existing array'.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11294"></span>11294</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore the discriminator byte.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="11295"></span>
<div class="comments">
<div class="paragraph">
The initial parameters of the new array are found.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">D_LETTER</td>
<td class="address-2"><span id="11295"></span>11295</td>
<td class="instruction">SET 7,C</td>
<td class="comment-1" rowspan="1">Set bit 7 in the discriminator byte.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11297"></span>11297</td>
<td class="instruction">LD B,0</td>
<td class="comment-1" rowspan="1">Make the dimension counter zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11299"></span>11299</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Save the counter and the discriminator byte.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11300"></span>11300</td>
<td class="instruction">LD HL,1</td>
<td class="comment-1" rowspan="4">The <span class="register">HL</span> register pair is to hold the size of the elements in the array: '1' for a string array, '5' for a numeric array.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11303"></span>11303</td>
<td class="instruction">BIT 6,C</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11305"></span>11305</td>
<td class="instruction">JR NZ,<a href="11266.html#11309">D_SIZE</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11307"></span>11307</td>
<td class="instruction">LD L,5</td>
</tr>
<tr>
<td class="asm-label">D_SIZE</td>
<td class="address-2"><span id="11309"></span>11309</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Element size to <span class="register">DE</span>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="11310"></span>
<div class="comments">
<div class="paragraph">
The following loop is accessed for each dimension that is specified in the parenthesised expression of the DIM statement. The total number of bytes required for the elements of the array is built up in the <span class="register">DE</span> register pair.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">D_NO_LOOP</td>
<td class="address-2"><span id="11310"></span>11310</td>
<td class="instruction">RST <a href="32.html">32</a></td>
<td class="comment-1" rowspan="1">Advance <a href="23645.html">CH-ADD</a> on each pass.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11311"></span>11311</td>
<td class="instruction">LD H,255</td>
<td class="comment-1" rowspan="1">Set a 'limit value'.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11313"></span>11313</td>
<td class="instruction">CALL <a href="10956.html">INT_EXP1</a></td>
<td class="comment-1" rowspan="1">Evaluate a parameter.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11316"></span>11316</td>
<td class="instruction">JP C,<a href="10646.html#10784">REPORT_3</a></td>
<td class="comment-1" rowspan="1">Give an error if 'out of range'.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11319"></span>11319</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Fetch the dimension counter and the discriminator byte.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11320"></span>11320</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Save the parameter on each pass through the loop.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11321"></span>11321</td>
<td class="instruction">INC H</td>
<td class="comment-1" rowspan="1">Increase the dimension counter on each pass also.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11322"></span>11322</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Restack the dimension counter and the discriminator byte.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11323"></span>11323</td>
<td class="instruction">LD H,B</td>
<td class="comment-1" rowspan="2">The parameter is moved to the <span class="register">HL</span> register pair.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11324"></span>11324</td>
<td class="instruction">LD L,C</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11325"></span>11325</td>
<td class="instruction">CALL <a href="10996.html">GET_HLxDE</a></td>
<td class="comment-1" rowspan="2">The byte total is built up in <span class="register">HL</span> and then transferred to <span class="register">DE</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11328"></span>11328</td>
<td class="instruction">EX DE,HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11329"></span>11329</td>
<td class="instruction">RST <a href="24.html">24</a></td>
<td class="comment-1" rowspan="3">Get the present character and go around the loop again if there is another dimension.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11330"></span>11330</td>
<td class="instruction">CP ","</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11332"></span>11332</td>
<td class="instruction">JR Z,<a href="11266.html#11310">D_NO_LOOP</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="11334"></span>
<div class="comments">
<div class="paragraph">
At this point the <span class="register">DE</span> register pair indicates the number of bytes required for the elements of the new array and the size of each dimension is stacked, on the machine stack.
</div>
<div class="paragraph">
Now check that there is indeed a closing bracket to the parenthesised expression.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11334"></span>11334</td>
<td class="instruction">CP ")"</td>
<td class="comment-1" rowspan="1">Is it a ')'?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11336"></span>11336</td>
<td class="instruction">JR NZ,<a href="11266.html#11269">D_RPORT_C</a></td>
<td class="comment-1" rowspan="1">Jump back if not so.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11338"></span>11338</td>
<td class="instruction">RST <a href="32.html">32</a></td>
<td class="comment-1" rowspan="1">Advance <a href="23645.html">CH-ADD</a> past it.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="11339"></span>
<div class="comments">
<div class="paragraph">
Allowance is now made for the dimension sizes.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11339"></span>11339</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Fetch the dimension counter and the discriminator byte.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11340"></span>11340</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="1">Pass the discriminator byte to the <span class="register">A</span> register for later.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11341"></span>11341</td>
<td class="instruction">LD L,B</td>
<td class="comment-1" rowspan="1">Move the counter to <span class="register">L</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11342"></span>11342</td>
<td class="instruction">LD H,0</td>
<td class="comment-1" rowspan="1">Clear the <span class="register">H</span> register.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11344"></span>11344</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="4">Increase the dimension counter by two and double the result and form the correct overall length for the variable by adding the element byte total.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11345"></span>11345</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11346"></span>11346</td>
<td class="instruction">ADD HL,HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11347"></span>11347</td>
<td class="instruction">ADD HL,DE</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11348"></span>11348</td>
<td class="instruction">JP C,<a href="7941.html#7957">REPORT_4</a></td>
<td class="comment-1" rowspan="1">Give the report 'Out of memory' if required.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11351"></span>11351</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1">Save the element byte total.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11352"></span>11352</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Save the dimension counter and the discriminator byte.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11353"></span>11353</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Save the overall length also.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11354"></span>11354</td>
<td class="instruction">LD B,H</td>
<td class="comment-1" rowspan="2">Move the overall length to <span class="register">BC</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11355"></span>11355</td>
<td class="instruction">LD C,L</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="11356"></span>
<div class="comments">
<div class="paragraph">
The required amount of room is made available for the new array at the end of the variables area.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11356"></span>11356</td>
<td class="instruction">LD HL,(23641)</td>
<td class="comment-1" rowspan="2">Make the <span class="register">HL</span> register pair point to the '128-byte' (<a href="23641.html">E-LINE</a>-1).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11359"></span>11359</td>
<td class="instruction">DEC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11360"></span>11360</td>
<td class="instruction">CALL <a href="5714.html#5717">MAKE_ROOM</a></td>
<td class="comment-1" rowspan="1">The room is made available.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11363"></span>11363</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span> is made to point to the first new location.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="11364"></span>
<div class="comments">
<div class="paragraph">
The parameters are now entered.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11364"></span>11364</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">The letter, suitably marked, is entered first.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11365"></span>11365</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="4">The overall length is fetched and decreased by '3'.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11366"></span>11366</td>
<td class="instruction">DEC BC</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11367"></span>11367</td>
<td class="instruction">DEC BC</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11368"></span>11368</td>
<td class="instruction">DEC BC</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11369"></span>11369</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11370"></span>11370</td>
<td class="instruction">LD (HL),C</td>
<td class="comment-1" rowspan="1">Enter the low length.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11371"></span>11371</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11372"></span>11372</td>
<td class="instruction">LD (HL),B</td>
<td class="comment-1" rowspan="1">Enter the high length.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11373"></span>11373</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Fetch the dimension counter.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11374"></span>11374</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="1">Move it to the <span class="register">A</span> register.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11375"></span>11375</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Advance <span class="register">HL</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11376"></span>11376</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">Enter the dimension count.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="11377"></span>
<div class="comments">
<div class="paragraph">
The elements of the new array are now 'cleared'.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11377"></span>11377</td>
<td class="instruction">LD H,D</td>
<td class="comment-1" rowspan="3"><span class="register">HL</span> is made to point to the last location of the array and <span class="register">DE</span> to the location before that one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11378"></span>11378</td>
<td class="instruction">LD L,E</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11379"></span>11379</td>
<td class="instruction">DEC DE</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11380"></span>11380</td>
<td class="instruction">LD (HL),0</td>
<td class="comment-1" rowspan="4">Enter a zero into the last location but overwrite it with 'space' if dealing with an array of strings.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11382"></span>11382</td>
<td class="instruction">BIT 6,C</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11384"></span>11384</td>
<td class="instruction">JR Z,<a href="11266.html#11388">DIM_CLEAR</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11386"></span>11386</td>
<td class="instruction">LD (HL)," "</td>
</tr>
<tr>
<td class="asm-label">DIM_CLEAR</td>
<td class="address-2"><span id="11388"></span>11388</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Fetch the element byte total.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11389"></span>11389</td>
<td class="instruction">LDDR</td>
<td class="comment-1" rowspan="1">Clear the array + one extra location.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="11391"></span>
<div class="comments">
<div class="paragraph">
The 'dimension sizes' are now entered.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">DIM_SIZES</td>
<td class="address-2"><span id="11391"></span>11391</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Get a dimension size.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11392"></span>11392</td>
<td class="instruction">LD (HL),B</td>
<td class="comment-1" rowspan="1">Enter the high byte.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11393"></span>11393</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="1">Back one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11394"></span>11394</td>
<td class="instruction">LD (HL),C</td>
<td class="comment-1" rowspan="1">Enter the low byte.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11395"></span>11395</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="1">Back one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11396"></span>11396</td>
<td class="instruction">DEC A</td>
<td class="comment-1" rowspan="1">Decrease the dimension counter.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11397"></span>11397</td>
<td class="instruction">JR NZ,<a href="11266.html#11391">DIM_SIZES</a></td>
<td class="comment-1" rowspan="2">Repeat the operation until all the dimensions have been considered; then return.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="11399"></span>11399</td>
<td class="instruction">RET</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="11249.html">11249</a>
</td>
<td class="up">Up: <a href="../maps/all.html#11266">Map</a></td>
<td class="next">
Next: <a href="11400.html">11400</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Spectrum ROM Disassembly 20221121</div>
<div class="copyright">&#169; 1982 Amstrad. &#169; 1983 Dr Ian Logan &amp; Dr Frank O'Hara. &#169; 2022 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.8.</div>
<div><a href="../../asm/2C02.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>