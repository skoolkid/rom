<!DOCTYPE html>
<html>
<head>
<title>Spectrum ROM: Routine at 09399</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Spectrum ROM" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="9341.html">09341</a>
</td>
<td class="up">Up: <a href="../maps/all.html#9399">Map</a></td>
<td class="next">
Next: <a href="9467.html">09467</a>
</td>
</tr>
</table>
<div class="description">09399: THE 'LINE-DRAWING' SUBROUTINE</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
This subroutine is called by <a href="9090.html">DRAW</a> to draw an approximation to a straight line from the point X0, Y0 held in <a href="23677.html">COORDS</a> to the point X0+X, Y0+Y, where the increments X and Y are on the top of the calculator stack. The subroutine was originally intended for the ZX80 and ZX81 8K ROM, and it is described in a BASIC program on page 121 of the ZX81 manual.
</div>
<div class="paragraph">
The method is to intersperse as many horizontal or vertical steps as are needed among a basic set of diagonal steps, using an algorithm that spaces the horizontal or vertical steps as evenly as possible.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">DRAW_LINE</td>
<td class="address-2"><span id="9399"></span>09399</td>
<td class="instruction">CALL <a href="8967.html">STK_TO_BC</a></td>
<td class="comment-1" rowspan="1">ABS Y to <span class="register">B</span>; ABS X to <span class="register">C</span>; SGN Y to <span class="register">D</span>; SGN X to <span class="register">E</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9402"></span>09402</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="4">Jump if ABS X is greater than or equal to ABS Y, so that the smaller goes to <span class="register">L</span>, and the larger (later) goes to <span class="register">H</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9403"></span>09403</td>
<td class="instruction">CP B</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9404"></span>09404</td>
<td class="instruction">JR NC,<a href="9399.html#9412">DL_X_GE_Y</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9406"></span>09406</td>
<td class="instruction">LD L,C</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9407"></span>09407</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1">Save diagonal step (+/-1,+/-1) in <span class="register">DE</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9408"></span>09408</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="2">Insert a vertical step (+/-1,0) into <span class="register">DE</span> (<span class="register">D</span> holds SGN Y).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9409"></span>09409</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9410"></span>09410</td>
<td class="instruction">JR <a href="9399.html#9419">DL_LARGER</a></td>
<td class="comment-1" rowspan="1">Now jump to set <span class="register">H</span>.</td>
</tr>
<tr>
<td class="asm-label">DL_X_GE_Y</td>
<td class="address-2"><span id="9412"></span>09412</td>
<td class="instruction">OR C</td>
<td class="comment-1" rowspan="2">Return if ABS X and ABS Y are both zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9413"></span>09413</td>
<td class="instruction">RET Z</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9414"></span>09414</td>
<td class="instruction">LD L,B</td>
<td class="comment-1" rowspan="1">The smaller (ABS Y here) goes to <span class="register">L</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9415"></span>09415</td>
<td class="instruction">LD B,C</td>
<td class="comment-1" rowspan="1">ABS X to <span class="register">B</span> here, for <span class="register">H</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9416"></span>09416</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1">Save the diagonal step here too.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9417"></span>09417</td>
<td class="instruction">LD D,0</td>
<td class="comment-1" rowspan="1">Horizontal step (0,+/-1) to <span class="register">DE</span> here.</td>
</tr>
<tr>
<td class="asm-label">DL_LARGER</td>
<td class="address-2"><span id="9419"></span>09419</td>
<td class="instruction">LD H,B</td>
<td class="comment-1" rowspan="1">Larger of ABS X, ABS Y to <span class="register">H</span> now.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="9420"></span>
<div class="comments">
<div class="paragraph">
The algorithm starts here. The larger of ABS X and ABS Y, say <span class="register">H</span>, is put into <span class="register">A</span> and reduced to INT (<span class="register">H</span>/2). The <span class="register">H</span>-<span class="register">L</span> horizontal or vertical steps and <span class="register">L</span> diagonal steps are taken (where <span class="register">L</span> is the smaller of ABS X and ABS Y) in this way: <span class="register">L</span> is added to <span class="register">A</span>; if <span class="register">A</span> now equals or exceeds <span class="register">H</span>, it is reduced by <span class="register">H</span> and a diagonal step is taken; otherwise a horizontal or vertical step is taken. This is repeated <span class="register">H</span> times (<span class="register">B</span> also holds <span class="register">H</span>). Note that meanwhile the exchange registers <span class="register">H'</span> and <span class="register">L'</span> are used to hold <a href="23677.html">COORDS</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9420"></span>09420</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="1"><span class="register">B</span> to <span class="register">A</span> as well as to <span class="register">H</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9421"></span>09421</td>
<td class="instruction">RRA</td>
<td class="comment-1" rowspan="1"><span class="register">A</span> starts at INT (<span class="register">H</span>/2).</td>
</tr>
<tr>
<td class="asm-label">D_L_LOOP</td>
<td class="address-2"><span id="9422"></span>09422</td>
<td class="instruction">ADD A,L</td>
<td class="comment-1" rowspan="1"><span class="register">L</span> is added to <span class="register">A</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9423"></span>09423</td>
<td class="instruction">JR C,<a href="9399.html#9428">D_L_DIAG</a></td>
<td class="comment-1" rowspan="1">If 256 or more, jump - diagonal step.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9425"></span>09425</td>
<td class="instruction">CP H</td>
<td class="comment-1" rowspan="2">If <span class="register">A</span> is less than <span class="register">H</span>, jump for horizontal or vertical step.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9426"></span>09426</td>
<td class="instruction">JR C,<a href="9399.html#9435">D_L_HR_VT</a></td>
</tr>
<tr>
<td class="asm-label">D_L_DIAG</td>
<td class="address-2"><span id="9428"></span>09428</td>
<td class="instruction">SUB H</td>
<td class="comment-1" rowspan="1">Reduce <span class="register">A</span> by <span class="register">H</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9429"></span>09429</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">Restore it to <span class="register">C</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9430"></span>09430</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1">Now use the exchange resisters.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9431"></span>09431</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Diagonal step to <span class="register">BC'</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9432"></span>09432</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Save it too.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9433"></span>09433</td>
<td class="instruction">JR <a href="9399.html#9439">D_L_STEP</a></td>
<td class="comment-1" rowspan="1">Jump to take the step.</td>
</tr>
<tr>
<td class="asm-label">D_L_HR_VT</td>
<td class="address-2"><span id="9435"></span>09435</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">Save <span class="register">A</span> (unreduced) in <span class="register">C</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9436"></span>09436</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1">Step to stack briefly.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9437"></span>09437</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1">Get exchange registers.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9438"></span>09438</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Step to <span class="register">BC'</span> now.</td>
</tr>
<tr>
<td class="asm-label">D_L_STEP</td>
<td class="address-2"><span id="9439"></span>09439</td>
<td class="instruction">LD HL,(23677)</td>
<td class="comment-1" rowspan="1">Now take the step: first, <a href="23677.html">COORDS</a> to <span class="register">HL'</span> as the start point.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9442"></span>09442</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="1">Y-step from <span class="register">B'</span> to <span class="register">A</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9443"></span>09443</td>
<td class="instruction">ADD A,H</td>
<td class="comment-1" rowspan="1">Add in <span class="register">H'</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9444"></span>09444</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">Result to <span class="register">B'</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9445"></span>09445</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="2">Now the X-step; it will be tested for range (Y will be tested in <a href="8924.html">PLOT</a>).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9446"></span>09446</td>
<td class="instruction">INC A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9447"></span>09447</td>
<td class="instruction">ADD A,L</td>
<td class="comment-1" rowspan="2">Add <span class="register">L'</span> to <span class="register">C'</span> in <span class="register">A</span>, jump on carry for further test.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9448"></span>09448</td>
<td class="instruction">JR C,<a href="9399.html#9463">D_L_RANGE</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9450"></span>09450</td>
<td class="instruction">JR Z,<a href="9399.html#9465">REPORT_B_3</a></td>
<td class="comment-1" rowspan="1">Zero after no carry denotes X-position -1, out of range.</td>
</tr>
<tr>
<td class="asm-label">D_L_PLOT</td>
<td class="address-2"><span id="9452"></span>09452</td>
<td class="instruction">DEC A</td>
<td class="comment-1" rowspan="1">Restore true value to <span class="register">A</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9453"></span>09453</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">Value to <span class="register">C'</span> for plotting.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9454"></span>09454</td>
<td class="instruction">CALL <a href="8924.html#8933">PLOT_SUB</a></td>
<td class="comment-1" rowspan="1">Plot the step.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9457"></span>09457</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1">Restore main registers.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9458"></span>09458</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="1"><span class="register">C</span> back to <span class="register">A</span> to continue algorithm.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9459"></span>09459</td>
<td class="instruction">DJNZ <a href="9399.html#9422">D_L_LOOP</a></td>
<td class="comment-1" rowspan="1">Loop back for <span class="register">B</span> steps (i.e. <span class="register">H</span> steps).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9461"></span>09461</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1">Clear machine stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9462"></span>09462</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Finished.</td>
</tr>
<tr>
<td class="asm-label">D_L_RANGE</td>
<td class="address-2"><span id="9463"></span>09463</td>
<td class="instruction">JR Z,<a href="9399.html#9452">D_L_PLOT</a></td>
<td class="comment-1" rowspan="1">Zero after carry denotes X-position 255, in range.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="9465"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routines at <a href="8874.html">PIXEL_ADD</a> and <a href="8980.html">STK_TO_A</a>.
</div>
<div class="paragraph">
Report B - Integer out of range.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">REPORT_B_3</td>
<td class="address-2"><span id="9465"></span>09465</td>
<td class="instruction">RST <a href="8.html">8</a></td>
<td class="comment-1" rowspan="2">Call the error handling routine.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9466"></span>09466</td>
<td class="instruction">DEFB 10</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="9341.html">09341</a>
</td>
<td class="up">Up: <a href="../maps/all.html#9399">Map</a></td>
<td class="next">
Next: <a href="9467.html">09467</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Spectrum ROM Disassembly 20200807</div>
<div class="copyright">&#169; 1982 Amstrad. &#169; 1983 Dr Ian Logan &amp; Dr Frank O'Hara. &#169; 2020 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
<div><a href="../../asm/24B7.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>