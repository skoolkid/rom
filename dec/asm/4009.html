<!DOCTYPE html>
<html>
<head>
<title>Spectrum ROM: Routine at 04009</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Spectrum ROM" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="4000.html">04000</a>
</td>
<td class="up">Up: <a href="../maps/all.html#4009">Map</a></td>
<td class="next">
Next: <a href="4083.html">04083</a>
</td>
</tr>
</table>
<div class="description">04009: THE 'EDIT KEY' SUBROUTINE</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
The address of this routine is derived from an offset found in the <a href="4000.html">editing keys table</a>.
</div>
<div class="paragraph">
When in 'editing mode' pressing the EDIT key will bring down the 'current BASIC line'. However in 'INPUT mode' the action of the EDIT key is to clear the current reply and allow a fresh one.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ED_EDIT</td>
<td class="address-2"><span id="4009"></span>04009</td>
<td class="instruction">LD HL,(23625)</td>
<td class="comment-1" rowspan="1">Fetch the current line number (<a href="23625.html">E-PPC</a>).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4012"></span>04012</td>
<td class="instruction">BIT 5,(IY+55)</td>
<td class="comment-1" rowspan="2">But jump forward if in 'INPUT mode' (bit 5 of <a href="23665.html">FLAGX</a> set).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4016"></span>04016</td>
<td class="instruction">JP NZ,<a href="4247.html">CLEAR_SP</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4019"></span>04019</td>
<td class="instruction">CALL <a href="6510.html">LINE_ADDR</a></td>
<td class="comment-1" rowspan="2">Find the address of the start of the current line and hence its number.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4022"></span>04022</td>
<td class="instruction">CALL <a href="5775.html#5781">LINE_NO</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4025"></span>04025</td>
<td class="instruction">LD A,D</td>
<td class="comment-1" rowspan="3">If the line number returned is zero then simply clear the editing area.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4026"></span>04026</td>
<td class="instruction">OR E</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4027"></span>04027</td>
<td class="instruction">JP Z,<a href="4247.html">CLEAR_SP</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4030"></span>04030</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Save the address of the line.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4031"></span>04031</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="4">Move on to collect the length of the line.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4032"></span>04032</td>
<td class="instruction">LD C,(HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4033"></span>04033</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4034"></span>04034</td>
<td class="instruction">LD B,(HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4035"></span>04035</td>
<td class="instruction">LD HL,10</td>
<td class="comment-1" rowspan="5">Add 10 to the length and test that there is sufficient room for a copy of the line.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4038"></span>04038</td>
<td class="instruction">ADD HL,BC</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4039"></span>04039</td>
<td class="instruction">LD B,H</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4040"></span>04040</td>
<td class="instruction">LD C,L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4041"></span>04041</td>
<td class="instruction">CALL <a href="7941.html">TEST_ROOM</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4044"></span>04044</td>
<td class="instruction">CALL <a href="4247.html">CLEAR_SP</a></td>
<td class="comment-1" rowspan="1">Now clear the editing area.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4047"></span>04047</td>
<td class="instruction">LD HL,(23633)</td>
<td class="comment-1" rowspan="2">Fetch the current channel address (<a href="23633.html">CURCHL</a>) and exchange it for the address of the line.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4050"></span>04050</td>
<td class="instruction">EX (SP),HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4051"></span>04051</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Save it temporarily.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4052"></span>04052</td>
<td class="instruction">LD A,255</td>
<td class="comment-1" rowspan="2">Open channel 'R' so that the line will be copied to the editing area.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4054"></span>04054</td>
<td class="instruction">CALL <a href="5633.html">CHAN_OPEN</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4057"></span>04057</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Fetch the address of the line.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4058"></span>04058</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="1">Go to before the line.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4059"></span>04059</td>
<td class="instruction">DEC (IY+15)</td>
<td class="comment-1" rowspan="1">Decrement the current line number (<a href="23625.html">E-PPC</a>) so as to avoid printing the cursor.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4062"></span>04062</td>
<td class="instruction">CALL <a href="6229.html">OUT_LINE</a></td>
<td class="comment-1" rowspan="1">Print the BASIC line.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4065"></span>04065</td>
<td class="instruction">INC (IY+15)</td>
<td class="comment-1" rowspan="1">Increment the current line number (<a href="23625.html">E-PPC</a>). Note: the decrementing of the line number <a href="../reference/bugs.html#curseTheCursor">does not always stop the cursor from being printed</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4068"></span>04068</td>
<td class="instruction">LD HL,(23641)</td>
<td class="comment-1" rowspan="6">Fetch the start of the line in the editing area (<a href="23641.html">E-LINE</a>) and step past the line number and the length to find the address for <a href="23643.html">K-CUR</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4071"></span>04071</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4072"></span>04072</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4073"></span>04073</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4074"></span>04074</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4075"></span>04075</td>
<td class="instruction">LD (23643),HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4078"></span>04078</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="3">Fetch the former channel address and set the appropriate flags before returning to <a href="3884.html#3896">ED_LOOP</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4079"></span>04079</td>
<td class="instruction">CALL <a href="5653.html">CHAN_FLAG</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="4082"></span>04082</td>
<td class="instruction">RET</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="4000.html">04000</a>
</td>
<td class="up">Up: <a href="../maps/all.html#4009">Map</a></td>
<td class="next">
Next: <a href="4083.html">04083</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Spectrum ROM Disassembly 20221121</div>
<div class="copyright">&#169; 1982 Amstrad. &#169; 1983 Dr Ian Logan &amp; Dr Frank O'Hara. &#169; 2022 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.8.</div>
<div><a href="../../asm/0FA9.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>