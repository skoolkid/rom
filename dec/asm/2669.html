<!DOCTYPE html>
<html>
<head>
<title>Spectrum ROM: Routine at 02669</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Spectrum ROM" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="2665.html">02665</a>
</td>
<td class="up">Up: <a href="../maps/all.html#2669">Map</a></td>
<td class="next">
Next: <a href="2777.html">02777</a>
</td>
</tr>
</table>
<div class="description">02669: THE 'CONTROL CHARACTERS WITH OPERANDS' ROUTINE</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
The control characters from INK to OVER require a single operand whereas the control characters AT and TAB are required to be followed by two operands.
</div>
<div class="paragraph">
The present routine leads to the control character code being saved in <a href="23566.html">TVDATA-lo</a>, the first operand in <a href="23566.html">TVDATA-hi</a> or the <span class="register">A</span> register if there is only a single operand required, and the second operand in the <span class="register">A</span> register.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">A</td>
<td class="register-desc">Control character code (16 to 23)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="asm-label">PO_TV_2</td>
<td class="address-2"><span id="2669"></span>02669</td>
<td class="instruction">LD DE,2695</td>
<td class="comment-1" rowspan="3">Save the first operand in <a href="23566.html">TVDATA-hi</a> and change the address of the 'output' routine to <a href="2669.html#2695">PO_CONT</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2672"></span>02672</td>
<td class="instruction">LD (23567),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2675"></span>02675</td>
<td class="instruction">JR <a href="2669.html#2688">PO_CHANGE</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="2677"></span>
<div class="comments">
<div class="paragraph">
The address of this entry point is derived from an offset found in the <a href="2577.html">control character table</a>.
</div>
<div class="paragraph">
Enter here when handling the characters AT and TAB.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">PO_2_OPER</td>
<td class="address-2"><span id="2677"></span>02677</td>
<td class="instruction">LD DE,2669</td>
<td class="comment-1" rowspan="2">The character code will be saved in <a href="23566.html">TVDATA-lo</a> and the address of the 'output' routine changed to <a href="2669.html">PO_TV_2</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2680"></span>02680</td>
<td class="instruction">JR <a href="2669.html#2685">PO_TV_1</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="2682"></span>
<div class="comments">
<div class="paragraph">
The address of this entry point is derived from an offset found in the <a href="2577.html">control character table</a>.
</div>
<div class="paragraph">
Enter here when handling the colour items - INK to OVER.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">PO_1_OPER</td>
<td class="address-2"><span id="2682"></span>02682</td>
<td class="instruction">LD DE,2695</td>
<td class="comment-1" rowspan="1">The 'output' routine is to be changed to <a href="2669.html#2695">PO_CONT</a>.</td>
</tr>
<tr>
<td class="asm-label">PO_TV_1</td>
<td class="address-2"><span id="2685"></span>02685</td>
<td class="instruction">LD (23566),A</td>
<td class="comment-1" rowspan="1">Save the control character code in <a href="23566.html">TVDATA-hi</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="2688"></span>
<div class="comments">
<div class="paragraph">
The current 'output' routine address is changed temporarily.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">PO_CHANGE</td>
<td class="address-2"><span id="2688"></span>02688</td>
<td class="instruction">LD HL,(23633)</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span> will point to the 'output' routine address (<a href="23633.html">CURCHL</a>).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2691"></span>02691</td>
<td class="instruction">LD (HL),E</td>
<td class="comment-1" rowspan="4">Enter the new 'output' routine address and thereby force the next character code to be considered as an operand.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2692"></span>02692</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2693"></span>02693</td>
<td class="instruction">LD (HL),D</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2694"></span>02694</td>
<td class="instruction">RET</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="2695"></span>
<div class="comments">
<div class="paragraph">
Once the operands have been collected the routine continues.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">PO_CONT</td>
<td class="address-1"><span id="2695"></span>02695</td>
<td class="instruction">LD DE,2548</td>
<td class="comment-1" rowspan="2">Restore the original address for <a href="2548.html">PRINT_OUT</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2698"></span>02698</td>
<td class="instruction">CALL <a href="2669.html#2688">PO_CHANGE</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2701"></span>02701</td>
<td class="instruction">LD HL,(23566)</td>
<td class="comment-1" rowspan="1">Fetch the control code and the first operand from <a href="23566.html">TVDATA</a> if there are indeed two operands.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2704"></span>02704</td>
<td class="instruction">LD D,A</td>
<td class="comment-1" rowspan="2">The 'last' operand and the control code are moved.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2705"></span>02705</td>
<td class="instruction">LD A,L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2706"></span>02706</td>
<td class="instruction">CP 22</td>
<td class="comment-1" rowspan="2">Jump forward if handling INK to OVER.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2708"></span>02708</td>
<td class="instruction">JP C,<a href="8673.html#8721">CO_TEMP_5</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2711"></span>02711</td>
<td class="instruction">JR NZ,<a href="2669.html#2754">PO_TAB</a></td>
<td class="comment-1" rowspan="1">Jump forward if handling TAB.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="2713"></span>
<div class="comments">
<div class="paragraph">
Now deal with the AT control character.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2713"></span>02713</td>
<td class="instruction">LD B,H</td>
<td class="comment-1" rowspan="1">The line number.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2714"></span>02714</td>
<td class="instruction">LD C,D</td>
<td class="comment-1" rowspan="1">The column number.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2715"></span>02715</td>
<td class="instruction">LD A,31</td>
<td class="comment-1" rowspan="2">Reverse the column number, i.e. 0 to 31 becomes 31 to 0.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2717"></span>02717</td>
<td class="instruction">SUB C</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2718"></span>02718</td>
<td class="instruction">JR C,<a href="2669.html#2732">PO_AT_ERR</a></td>
<td class="comment-1" rowspan="1">Must be in range.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2720"></span>02720</td>
<td class="instruction">ADD A,2</td>
<td class="comment-1" rowspan="2">Add in the offset to give <span class="register">C</span> holding 33 to 2.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2722"></span>02722</td>
<td class="instruction">LD C,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2723"></span>02723</td>
<td class="instruction">BIT 1,(IY+1)</td>
<td class="comment-1" rowspan="2">Jump forward if handling the printer (bit 1 of <a href="23611.html">FLAGS</a> set).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2727"></span>02727</td>
<td class="instruction">JR NZ,<a href="2669.html#2751">PO_AT_SET</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2729"></span>02729</td>
<td class="instruction">LD A,22</td>
<td class="comment-1" rowspan="2">Reverse the line number, i.e. 0 to 21 becomes 22 to 1.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2731"></span>02731</td>
<td class="instruction">SUB B</td>
</tr>
<tr>
<td class="asm-label">PO_AT_ERR</td>
<td class="address-2"><span id="2732"></span>02732</td>
<td class="instruction">JP C,<a href="7828.html#7839">REPORT_B_2</a></td>
<td class="comment-1" rowspan="1">If appropriate jump forward.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2735"></span>02735</td>
<td class="instruction">INC A</td>
<td class="comment-1" rowspan="2">The range 22 to 1 becomes 23 to 2.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2736"></span>02736</td>
<td class="instruction">LD B,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2737"></span>02737</td>
<td class="instruction">INC B</td>
<td class="comment-1" rowspan="1">And now 24 to 3.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2738"></span>02738</td>
<td class="instruction">BIT 0,(IY+2)</td>
<td class="comment-1" rowspan="2">If printing in the lower part of the screen (bit 0 of <a href="23612.html">TV-FLAG</a> set) then consider whether scrolling is needed.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2742"></span>02742</td>
<td class="instruction">JP NZ,<a href="3157.html">PO_SCR</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2745"></span>02745</td>
<td class="instruction">CP (IY+49)</td>
<td class="comment-1" rowspan="2">Give report 5 - Out of screen, if required (<a href="23659.html">DF-SZ</a>&gt;<span class="register">A</span>).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2748"></span>02748</td>
<td class="instruction">JP C,<a href="3157.html#3206">REPORT_5</a></td>
</tr>
<tr>
<td class="asm-label">PO_AT_SET</td>
<td class="address-2"><span id="2751"></span>02751</td>
<td class="instruction">JP <a href="3545.html">CL_SET</a></td>
<td class="comment-1" rowspan="1">Return via <a href="3545.html">CL_SET</a> and <a href="2780.html">PO_STORE</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="2754"></span>
<div class="comments">
<div class="paragraph">
And the TAB control character.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">PO_TAB</td>
<td class="address-2"><span id="2754"></span>02754</td>
<td class="instruction">LD A,H</td>
<td class="comment-1" rowspan="1">Fetch the first operand.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="2755"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="2655.html">PO_COMMA</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">PO_FILL</td>
<td class="address-2"><span id="2755"></span>02755</td>
<td class="instruction">CALL <a href="2819.html">PO_FETCH</a></td>
<td class="comment-1" rowspan="1">The current print position.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2758"></span>02758</td>
<td class="instruction">ADD A,C</td>
<td class="comment-1" rowspan="1">Add the current column value.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2759"></span>02759</td>
<td class="instruction">DEC A</td>
<td class="comment-1" rowspan="3">Find how many spaces, modulo 32, are required and return if the result is zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2760"></span>02760</td>
<td class="instruction">AND 31</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2762"></span>02762</td>
<td class="instruction">RET Z</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2763"></span>02763</td>
<td class="instruction">LD D,A</td>
<td class="comment-1" rowspan="1">Use <span class="register">D</span> as the counter.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2764"></span>02764</td>
<td class="instruction">SET 0,(IY+1)</td>
<td class="comment-1" rowspan="1">Suppress 'leading space' (set bit 0 of <a href="23611.html">FLAGS</a>).</td>
</tr>
<tr>
<td class="asm-label">PO_SPACE</td>
<td class="address-2"><span id="2768"></span>02768</td>
<td class="instruction">LD A," "</td>
<td class="comment-1" rowspan="4">Print <span class="register">D</span> number of spaces.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2770"></span>02770</td>
<td class="instruction">CALL <a href="3131.html">PO_SAVE</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2773"></span>02773</td>
<td class="instruction">DEC D</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2774"></span>02774</td>
<td class="instruction">JR NZ,<a href="2669.html#2768">PO_SPACE</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2776"></span>02776</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Now finished.</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="2665.html">02665</a>
</td>
<td class="up">Up: <a href="../maps/all.html#2669">Map</a></td>
<td class="next">
Next: <a href="2777.html">02777</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Spectrum ROM Disassembly 20200807</div>
<div class="copyright">&#169; 1982 Amstrad. &#169; 1983 Dr Ian Logan &amp; Dr Frank O'Hara. &#169; 2020 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
<div><a href="../../asm/0A6D.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>