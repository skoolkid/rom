<!DOCTYPE html>
<html>
<head>
<title>Spectrum ROM: Routine at 06651</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Spectrum ROM" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="6629.html">06629</a>
</td>
<td class="up">Up: <a href="../maps/all.html#6651">Map</a></td>
<td class="next">
Next: <a href="6683.html">06683</a>
</td>
</tr>
</table>
<div class="description">06651: THE 'E-LINE-NO' SUBROUTINE</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="4770.html">MAIN_EXEC</a> and <a href="6935.html">LINE_SCAN</a>.
</div>
<div class="paragraph">
This subroutine is used to read the line number of the line in the editing area. If there is no line number, i.e. a direct BASIC line, then the line number is considered to be zero.
</div>
</div>
<table class="output">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>
<tr>
<td class="register">BC</td>
<td class="register-desc">Number of the line in the editing area (or 0 if none)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="asm-label">E_LINE_NO</td>
<td class="address-2"><span id="6651"></span>06651</td>
<td class="instruction">LD HL,(23641)</td>
<td class="comment-1" rowspan="1">Pick up the pointer to the edit-line (<a href="23641.html">E-LINE</a>).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6654"></span>06654</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="2">Set <a href="23645.html">CH-ADD</a> to point to the location before any number.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6655"></span>06655</td>
<td class="instruction">LD (23645),HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6658"></span>06658</td>
<td class="instruction">RST <a href="32.html">32</a></td>
<td class="comment-1" rowspan="1">Pass the first code to the <span class="register">A</span> register.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6659"></span>06659</td>
<td class="instruction">LD HL,23698</td>
<td class="comment-1" rowspan="2">However before considering the code make the calculator's memory area a temporary calculator stack area (by setting <a href="23653.html">STKEND</a> equal to <a href="23698.html">MEMBOT</a>).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6662"></span>06662</td>
<td class="instruction">LD (23653),HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6665"></span>06665</td>
<td class="instruction">CALL <a href="11579.html">INT_TO_FP</a></td>
<td class="comment-1" rowspan="1">Now read the digits of the line number. Return zero if no number exists.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6668"></span>06668</td>
<td class="instruction">CALL <a href="11682.html">FP_TO_BC</a></td>
<td class="comment-1" rowspan="1">Compress the line number into the <span class="register">BC</span> register pair.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6671"></span>06671</td>
<td class="instruction">JR C,<a href="6651.html#6677">E_L_1</a></td>
<td class="comment-1" rowspan="1">Jump forward if the number exceeds 65,536.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6673"></span>06673</td>
<td class="instruction">LD HL,55536</td>
<td class="comment-1" rowspan="2">Otherwise test it against 10,000.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6676"></span>06676</td>
<td class="instruction">ADD HL,BC</td>
</tr>
<tr>
<td class="asm-label">E_L_1</td>
<td class="address-2"><span id="6677"></span>06677</td>
<td class="instruction">JP C,<a href="7289.html#7306">REPORT_C</a></td>
<td class="comment-1" rowspan="1">Give report C if over 9,999.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="6680"></span>06680</td>
<td class="instruction">JP <a href="5808.html#5829">SET_STK</a></td>
<td class="comment-1" rowspan="1">Return via <a href="5808.html#5829">SET_STK</a> that restores the calculator stack to its rightful place.</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="6629.html">06629</a>
</td>
<td class="up">Up: <a href="../maps/all.html#6651">Map</a></td>
<td class="next">
Next: <a href="6683.html">06683</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Spectrum ROM Disassembly 20200807</div>
<div class="copyright">&#169; 1982 Amstrad. &#169; 1983 Dr Ian Logan &amp; Dr Frank O'Hara. &#169; 2020 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
<div><a href="../../asm/19FB.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>