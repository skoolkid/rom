<!DOCTYPE html>
<html>
<head>
<title>Spectrum ROM: Routine at 09651</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Spectrum ROM" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="9647.html">09647</a>
</td>
<td class="up">Up: <a href="../maps/all.html#9651">Map</a></td>
<td class="next">
Next: <a href="9704.html">09704</a>
</td>
</tr>
</table>
<div class="description">09651: THE 'SCANNING QUOTE' ROUTINE</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
The address of this routine is derived from an offset found in the <a href="9622.html">scanning function table</a>.
</div>
<div class="paragraph">
This routine deals with string quotes, whether simple like "name" or more complex like "a ""white"" lie" or the seemingly redundant VAL$ """a""".
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">S_QUOTE</td>
<td class="address-2"><span id="9651"></span>09651</td>
<td class="instruction">RST <a href="24.html">24</a></td>
<td class="comment-1" rowspan="1">Fetch the current character.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9652"></span>09652</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Point to the start of the string.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9653"></span>09653</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Save the start address.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9654"></span>09654</td>
<td class="instruction">LD BC,0</td>
<td class="comment-1" rowspan="1">Set the length to zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9657"></span>09657</td>
<td class="instruction">CALL <a href="9487.html">S_QUOTE_S</a></td>
<td class="comment-1" rowspan="1">Call the "matching" subroutine.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9660"></span>09660</td>
<td class="instruction">JR NZ,<a href="9651.html#9689">S_Q_PRMS</a></td>
<td class="comment-1" rowspan="1">Jump if zero reset - no more quotes.</td>
</tr>
<tr>
<td class="asm-label">S_Q_AGAIN</td>
<td class="address-2"><span id="9662"></span>09662</td>
<td class="instruction">CALL <a href="9487.html">S_QUOTE_S</a></td>
<td class="comment-1" rowspan="1">Call it again for a third quote.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9665"></span>09665</td>
<td class="instruction">JR Z,<a href="9651.html#9662">S_Q_AGAIN</a></td>
<td class="comment-1" rowspan="1">And again for the fifth, seventh etc.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9667"></span>09667</td>
<td class="instruction">CALL <a href="9520.html">SYNTAX_Z</a></td>
<td class="comment-1" rowspan="2">If testing syntax, jump to reset bit 6 of <a href="23611.html">FLAGS</a> and to continue scanning.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9670"></span>09670</td>
<td class="instruction">JR Z,<a href="9651.html#9689">S_Q_PRMS</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9672"></span>09672</td>
<td class="instruction">RST <a href="48.html">48</a></td>
<td class="comment-1" rowspan="1">Make space in the work space for the string and the terminating quote.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9673"></span>09673</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Get the pointer to the start.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9674"></span>09674</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1">Save the pointer to the first space.</td>
</tr>
<tr>
<td class="asm-label">S_Q_COPY</td>
<td class="address-2"><span id="9675"></span>09675</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Get a character from the string.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9676"></span>09676</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Point to the next one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9677"></span>09677</td>
<td class="instruction">LD (DE),A</td>
<td class="comment-1" rowspan="1">Copy last one to work space.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9678"></span>09678</td>
<td class="instruction">INC DE</td>
<td class="comment-1" rowspan="1">Point to the next space.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9679"></span>09679</td>
<td class="instruction">CP "\""</td>
<td class="comment-1" rowspan="1">Is last character a '"'?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9681"></span>09681</td>
<td class="instruction">JR NZ,<a href="9651.html#9675">S_Q_COPY</a></td>
<td class="comment-1" rowspan="1">If not, jump to copy next one.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9683"></span>09683</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="4">But if it was, do not copy next one; if next one is a '"', jump to copy the one after it; otherwise, finished with copying.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9684"></span>09684</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9685"></span>09685</td>
<td class="instruction">CP "\""</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9687"></span>09687</td>
<td class="instruction">JR Z,<a href="9651.html#9675">S_Q_COPY</a></td>
</tr>
<tr>
<td class="asm-label">S_Q_PRMS</td>
<td class="address-2"><span id="9689"></span>09689</td>
<td class="instruction">DEC BC</td>
<td class="comment-1" rowspan="1">Get true length to <span class="register">BC</span>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="9690"></span>
<div class="comments">
<div class="paragraph">
Note that the first quote was not counted into the length; the final quote was, and is discarded now. Inside the string, the first, third, fifth, etc., quotes were counted in but the second, fourth, etc., were not.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9690"></span>09690</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1">Restore start of copied string.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="9691"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="9832.html">S_SCREEN</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">S_STRING</td>
<td class="address-2"><span id="9691"></span>09691</td>
<td class="instruction">LD HL,23611</td>
<td class="comment-1" rowspan="4">This is <a href="23611.html">FLAGS</a>; this entry point is used whenever bit 6 is to be reset and a string stacked if executing a line. This is done now.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9694"></span>09694</td>
<td class="instruction">RES 6,(HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9696"></span>09696</td>
<td class="instruction">BIT 7,(HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9698"></span>09698</td>
<td class="instruction">CALL NZ,<a href="10929.html#10930">STK_STO</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="9701"></span>09701</td>
<td class="instruction">JP <a href="9929.html#10002">S_CONT_2</a></td>
<td class="comment-1" rowspan="1">Jump to continue scanning the line.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<div class="comments">
<div class="paragraph">
Note that in copying the string to the work space, every two pairs of string quotes inside the string ("") have been reduced to one pair of string quotes(").
</div>
</div>
</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="9647.html">09647</a>
</td>
<td class="up">Up: <a href="../maps/all.html#9651">Map</a></td>
<td class="next">
Next: <a href="9704.html">09704</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Spectrum ROM Disassembly 20200807</div>
<div class="copyright">&#169; 1982 Amstrad. &#169; 1983 Dr Ian Logan &amp; Dr Frank O'Hara. &#169; 2020 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
<div><a href="../../asm/25B3.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>