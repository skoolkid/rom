<!DOCTYPE html>
<html>
<head>
<title>Spectrum ROM: Routine at 07202</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Spectrum ROM" src="../../images/logo-dec.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="7199.html">07199</a>
</td>
<td class="up">Up: <a href="../maps/all.html#7202">Map</a></td>
<td class="next">
Next: <a href="7246.html">07246</a>
</td>
</tr>
</table>
<div class="description">07202: THE 'VARIABLE IN ASSIGNMENT' SUBROUTINE</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="7276.html">CLASS_04</a>.
</div>
<div class="paragraph">
The routine at <a href="7199.html">CLASS_01</a> continues here.
</div>
<div class="paragraph">
This subroutine develops the appropriate values for the system variables <a href="23629.html">DEST</a> and <a href="23666.html">STRLEN</a>.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">C</td>
<td class="register-desc">Bit 5: Set if the variable is numeric, reset if it's a string</td>
</tr>
<tr>
<td class="register">C</td>
<td class="register-desc">Bit 6: Set if the variable is simple, reset if it's an array</td>
</tr>
<tr>
<td class="register">C</td>
<td class="register-desc">Bit 7: Set if checking syntax, reset if executing</td>
</tr>
<tr>
<td class="register">HL</td>
<td class="register-desc">Address of the last letter of the variable's name (in the variables area, if it exists)</td>
</tr>
<tr>
<td class="register">F</td>
<td class="register-desc">Carry flag reset if the variable already exists</td>
</tr>
<tr>
<td class="register">F</td>
<td class="register-desc">Zero flag reset if the variable is simple (not an array) and does not exist</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="asm-label">VAR_A_1</td>
<td class="address-2"><span id="7202"></span>07202</td>
<td class="instruction">LD (IY+55),0</td>
<td class="comment-1" rowspan="1">Initialise <a href="23665.html">FLAGX</a> to 0.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="7206"></span>07206</td>
<td class="instruction">JR NC,<a href="7202.html#7216">VAR_A_2</a></td>
<td class="comment-1" rowspan="1">Jump forward if the variable has been used before.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="7208"></span>07208</td>
<td class="instruction">SET 1,(IY+55)</td>
<td class="comment-1" rowspan="1">Signal 'a new variable' (set bit 1 of <a href="23665.html">FLAGX</a>).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="7212"></span>07212</td>
<td class="instruction">JR NZ,<a href="7202.html#7238">VAR_A_3</a></td>
<td class="comment-1" rowspan="1">Give an error if trying to use an 'undimensioned array'.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="7214"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routines at <a href="7595.html">NEXT</a> and <a href="9929.html">S_LETTER</a>.
</div>
<div class="paragraph">
Report 2 - Variable not found.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">REPORT_2</td>
<td class="address-2"><span id="7214"></span>07214</td>
<td class="instruction">RST <a href="8.html">8</a></td>
<td class="comment-1" rowspan="2">Call the error handling routine.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="7215"></span>07215</td>
<td class="instruction">DEFB 1</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="7216"></span>
<div class="comments">
<div class="paragraph">
Continue with the handling of existing variables.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">VAR_A_2</td>
<td class="address-2"><span id="7216"></span>07216</td>
<td class="instruction">CALL Z,<a href="10646.html">STK_VAR</a></td>
<td class="comment-1" rowspan="1">The parameters of simple string variables and all array variables are passed to the calculator stack. (<a href="10646.html">STK_VAR</a> will 'slice' a string if required.)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="7219"></span>07219</td>
<td class="instruction">BIT 6,(IY+1)</td>
<td class="comment-1" rowspan="2">Jump forward if handling a numeric variable (bit 6 of <a href="23611.html">FLAGS</a> set).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="7223"></span>07223</td>
<td class="instruction">JR NZ,<a href="7202.html#7238">VAR_A_3</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="7225"></span>07225</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Clear the <span class="register">A</span> register.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="7226"></span>07226</td>
<td class="instruction">CALL <a href="9520.html">SYNTAX_Z</a></td>
<td class="comment-1" rowspan="2">The parameters of the string or string array variable are fetched unless syntax is being checked.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="7229"></span>07229</td>
<td class="instruction">CALL NZ,<a href="11249.html">STK_FETCH</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="7232"></span>07232</td>
<td class="instruction">LD HL,23665</td>
<td class="comment-1" rowspan="1">This is <a href="23665.html">FLAGX</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="7235"></span>07235</td>
<td class="instruction">OR (HL)</td>
<td class="comment-1" rowspan="2">Bit 0 is set only when handling complete 'simple strings' thereby signalling 'old copy to be deleted'.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="7236"></span>07236</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="7237"></span>07237</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span> now points to the string or the element of the array.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="7238"></span>
<div class="comments">
<div class="paragraph">
The pathways now come together to set <a href="23666.html">STRLEN</a> and <a href="23629.html">DEST</a> as required. For all numeric variables and 'new' string and string array variables <a href="23666.html">STRLEN-lo</a> holds the 'letter' of the variable's name. But for 'old' string and string array variables whether 'sliced' or complete it holds the 'length' in 'assignment'.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">VAR_A_3</td>
<td class="address-2"><span id="7238"></span>07238</td>
<td class="instruction">LD (23666),BC</td>
<td class="comment-1" rowspan="1">Set <a href="23666.html">STRLEN</a> as required.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="7242"></span>
<div class="comments">
<div class="paragraph">
<a href="23629.html">DEST</a> holds the address for the 'destination' of an 'old' variable but in effect the 'source' for a 'new' variable.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="7242"></span>07242</td>
<td class="instruction">LD (23629),HL</td>
<td class="comment-1" rowspan="2">Set <a href="23629.html">DEST</a> as required and return.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="7245"></span>07245</td>
<td class="instruction">RET</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="7199.html">07199</a>
</td>
<td class="up">Up: <a href="../maps/all.html#7202">Map</a></td>
<td class="next">
Next: <a href="7246.html">07246</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Spectrum ROM Disassembly 20200807</div>
<div class="copyright">&#169; 1982 Amstrad. &#169; 1983 Dr Ian Logan &amp; Dr Frank O'Hara. &#169; 2020 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
<div><a href="../../asm/1C22.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>