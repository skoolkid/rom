<!DOCTYPE html>
<html>
<head>
<title>Spectrum ROM: Routine at 13254</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />

</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Spectrum ROM" src="../../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="13248.html">13248</a></span></td>
<td class="up">Up: <a href="../maps/all.html#13254">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="13303.html">13303</a></span></td>
</tr>
</table>
<div class="description">13254: THE 'STACK LITERALS' SUBROUTINE (offset 52)</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="13385.html">series</a>.
</div>
<div class="paragraph">
The address of this routine is found in the <a href="13015.html">table of addresses</a>. It is called via the calculator literal 52 by the routines at <a href="1016.html">BEEP</a>, <a href="9341.html">CD_PRMS1</a>, <a href="9720.html">S_RND</a>, <a href="11713.html">LOG_2_A</a>, <a href="14020.html">exp</a>, <a href="14099.html">ln</a> and <a href="14211.html">get_argt</a>.
</div>
<div class="paragraph">
This subroutine places on the calculator stack, as a 'last value', the floating-point number supplied to it as 2, 3, 4 or 5 literals.
</div>
<div class="paragraph">
When called by using offset '52' the literals follow the '52' in the list of literals; when called by the <a href="13385.html">series generator</a>, the literals are supplied by the subroutine that called for a series to be generated; and when called by <a href="13303.html">SKIP_CONS</a> and <a href="13339.html">stk_con</a> the literals are obtained from the calculator's <a href="12997.html">table of constants</a>.
</div>
<div class="paragraph">
In each case, the first literal supplied is divided by 64, and the integer quotient plus 1 determines whether 1, 2, 3 or 4 further literals will be taken from the source to form the mantissa of the number. Any unfilled bytes of the five bytes that go to form a 5-byte floating-point number are set to zero. The first literal is also used to determine the exponent, after reducing mod 64, unless the remainder is zero, in which case the second literal is used, as it stands, without reducing mod 64. In either case, 80 is added to the literal, giving the augmented exponent byte, e (the true exponent e' plus 128). The rest of the 5 bytes are stacked, including any zeros needed, and the subroutine returns.
</div>
</div>
<table class="input-1">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">DE</td>
<td class="register-desc"><a href="23653.html">STKEND</a></td>
</tr>
<tr>
<td class="register">HL'</td>
<td class="register-desc">Address of the next literal</td>
</tr>
</table>
<table class="output-0">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>

</table>
</td>
</tr>
<tr>
<td class="asm-label-1">stk_data</td>
<td class="address-2"><span id="13254"></span>13254</td>
<td class="bytes-0"></td>
<td class="instruction">LD H,D</td>
<td class="comment-11" rowspan="2">This subroutine performs the manipulatory operation of adding a 'last value' to the calculator stack; hence <span class="register">HL</span> is set to point one past the present 'last value' and hence point to the result.</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13255"></span>13255</td>
<td class="bytes-0"></td>
<td class="instruction">LD L,E</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="13256"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routines at <a href="13303.html">SKIP_CONS</a> and <a href="13339.html">stk_con</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label-1">STK_CONST</td>
<td class="address-2"><span id="13256"></span>13256</td>
<td class="bytes-0"></td>
<td class="instruction">CALL <a href="13225.html">TEST_5_SP</a></td>
<td class="comment-11" rowspan="1">Now test that there is indeed room.</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13259"></span>13259</td>
<td class="bytes-0"></td>
<td class="instruction">EXX</td>
<td class="comment-11" rowspan="3">Go to the alternate register set and stack the pointer to the next literal.</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13260"></span>13260</td>
<td class="bytes-0"></td>
<td class="instruction">PUSH HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13261"></span>13261</td>
<td class="bytes-0"></td>
<td class="instruction">EXX</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13262"></span>13262</td>
<td class="bytes-0"></td>
<td class="instruction">EX (SP),HL</td>
<td class="comment-11" rowspan="1">Switch over the result pointer and the next literal pointer.</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13263"></span>13263</td>
<td class="bytes-0"></td>
<td class="instruction">PUSH BC</td>
<td class="comment-11" rowspan="1">Save <span class="register">BC</span> briefly.</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13264"></span>13264</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="4">The first literal is put into <span class="register">A</span> and divided by 64 to give the integer values 0, 1, 2 or 3.</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13265"></span>13265</td>
<td class="bytes-0"></td>
<td class="instruction">AND 192</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13267"></span>13267</td>
<td class="bytes-0"></td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13268"></span>13268</td>
<td class="bytes-0"></td>
<td class="instruction">RLCA</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13269"></span>13269</td>
<td class="bytes-0"></td>
<td class="instruction">LD C,A</td>
<td class="comment-11" rowspan="2">The integer value is transferred to <span class="register">C</span> and incremented, thereby giving the range 1, 2, 3 or 4 for the number of literals that will be needed.</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13270"></span>13270</td>
<td class="bytes-0"></td>
<td class="instruction">INC C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13271"></span>13271</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-11" rowspan="5">The literal is fetched anew, reduced mod 64 and discarded as inappropriate if the remainder if zero; in which case the next literal is fetched and used unreduced.</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13272"></span>13272</td>
<td class="bytes-0"></td>
<td class="instruction">AND 63</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13274"></span>13274</td>
<td class="bytes-0"></td>
<td class="instruction">JR NZ,<a href="13254.html#13278">FORM_EXP</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13276"></span>13276</td>
<td class="bytes-0"></td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13277"></span>13277</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">FORM_EXP</td>
<td class="address-2"><span id="13278"></span>13278</td>
<td class="bytes-0"></td>
<td class="instruction">ADD A,80</td>
<td class="comment-11" rowspan="2">The exponent, e, is formed by the addition of 80 and passed to the calculator stack as the first of the five bytes of the result.</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13280"></span>13280</td>
<td class="bytes-0"></td>
<td class="instruction">LD (DE),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13281"></span>13281</td>
<td class="bytes-0"></td>
<td class="instruction">LD A,5</td>
<td class="comment-11" rowspan="6">The number of literals specified in <span class="register">C</span> are taken from the source and entered into the bytes of the result.</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13283"></span>13283</td>
<td class="bytes-0"></td>
<td class="instruction">SUB C</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13284"></span>13284</td>
<td class="bytes-0"></td>
<td class="instruction">INC HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13285"></span>13285</td>
<td class="bytes-0"></td>
<td class="instruction">INC DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13286"></span>13286</td>
<td class="bytes-0"></td>
<td class="instruction">LD B,0</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13288"></span>13288</td>
<td class="bytes-0"></td>
<td class="instruction">LDIR</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13290"></span>13290</td>
<td class="bytes-0"></td>
<td class="instruction">POP BC</td>
<td class="comment-11" rowspan="1">Restore <span class="register">BC</span>.</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13291"></span>13291</td>
<td class="bytes-0"></td>
<td class="instruction">EX (SP),HL</td>
<td class="comment-11" rowspan="4">Return the result pointer to <span class="register">HL</span> and the next literal pointer to its usual position in <span class="register">HL'</span>.</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13292"></span>13292</td>
<td class="bytes-0"></td>
<td class="instruction">EXX</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13293"></span>13293</td>
<td class="bytes-0"></td>
<td class="instruction">POP HL</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13294"></span>13294</td>
<td class="bytes-0"></td>
<td class="instruction">EXX</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13295"></span>13295</td>
<td class="bytes-0"></td>
<td class="instruction">LD B,A</td>
<td class="comment-11" rowspan="7">The number of zero bytes required at this stage is given by 5-<span class="register">C</span>-1, and this number of zeros is added to the result to make up the required five bytes.</td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13296"></span>13296</td>
<td class="bytes-0"></td>
<td class="instruction">XOR A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1">STK_ZEROS</td>
<td class="address-2"><span id="13297"></span>13297</td>
<td class="bytes-0"></td>
<td class="instruction">DEC B</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13298"></span>13298</td>
<td class="bytes-0"></td>
<td class="instruction">RET Z</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13299"></span>13299</td>
<td class="bytes-0"></td>
<td class="instruction">LD (DE),A</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13300"></span>13300</td>
<td class="bytes-0"></td>
<td class="instruction">INC DE</td>
<td class="comment-01" rowspan="1"></td>
</tr>
<tr>
<td class="asm-label-1"></td>
<td class="address-1"><span id="13301"></span>13301</td>
<td class="bytes-0"></td>
<td class="instruction">JR <a href="13254.html#13297">STK_ZEROS</a></td>
<td class="comment-01" rowspan="1"></td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev"><span class="prev-1">Prev: <a href="13248.html">13248</a></span></td>
<td class="up">Up: <a href="../maps/all.html#13254">Map</a></td>
<td class="next"><span class="next-1">Next: <a href="13303.html">13303</a></span></td>
</tr>
</table>
<footer>
<div class="release">The Complete Spectrum ROM Disassembly 20190603</div>
<div class="copyright">&#169; 1982 Amstrad. &#169; 1983 Dr Ian Logan &amp; Dr Frank O'Hara. &#169; 2019 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 7.2.</div>
<div><a href="../../asm/33C6.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>