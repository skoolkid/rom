<!DOCTYPE html>
<html>
<head>
<title>Spectrum ROM: Routine at 2DD5</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Spectrum ROM" src="../images/logo-hex.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="2DC1.html">2DC1</a>
</td>
<td class="up">Up: <a href="../maps/all.html#2DD5">Map</a></td>
<td class="next">
Next: <a href="2DE3.html">2DE3</a>
</td>
</tr>
</table>
<div class="description">2DD5: THE 'FLOATING-POINT TO A' SUBROUTINE</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="1E85.html">TWO_PARAM</a>, <a href="1E94.html">FIND_INT1</a>, <a href="2314.html">STK_TO_A</a>, <a href="247D.html">CD_PRMS1</a>, <a href="2C9B.html">DEC_TO_FP</a>, <a href="2DE3.html">PRINT_FP</a>, <a href="35C9.html">chrs</a> and <a href="36C4.html">exp</a>.
</div>
<div class="paragraph">
The routine at <a href="2DC1.html">LOG_2_A</a> continues here.
</div>
<div class="paragraph">
This short but vital subroutine is called at least 8 times for various purposes. It uses <a href="2DA2.html">FP_TO_BC</a> to get the 'last value' into the <span class="register">A</span> register where this is possible. It therefore tests whether the modulus of the number rounds to more than 255 and if it does the subroutine returns with the carry flag set. Otherwise it returns with the modulus of the number, rounded to the nearest integer, in the <span class="register">A</span> register, and the zero flag set to imply that the number was positive, or reset to imply that it was negative.
</div>
</div>
<table class="output">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>
<tr>
<td class="register">A</td>
<td class="register-desc">Last value from the calculator stack</td>
</tr>
<tr>
<td class="register">F</td>
<td class="register-desc">Carry flag set on overflow</td>
</tr>
<tr>
<td class="register">F</td>
<td class="register-desc">Zero flag set if the value is positive, reset if negative</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="asm-label">FP_TO_A</td>
<td class="address-2"><span id="2DD5"></span>2DD5</td>
<td class="instruction">CALL <a href="2DA2.html">FP_TO_BC</a></td>
<td class="comment-1" rowspan="1">Compress the 'last value' into <span class="register">BC</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2DD8"></span>2DD8</td>
<td class="instruction">RET C</td>
<td class="comment-1" rowspan="1">Return if out of range already.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2DD9"></span>2DD9</td>
<td class="instruction">PUSH AF</td>
<td class="comment-1" rowspan="1">Save the result and the flags.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2DDA"></span>2DDA</td>
<td class="instruction">DEC B</td>
<td class="comment-1" rowspan="2">Again it will be out of range if the <span class="register">B</span> register does not hold zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2DDB"></span>2DDB</td>
<td class="instruction">INC B</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2DDC"></span>2DDC</td>
<td class="instruction">JR Z,<a href="2DD5.html#2DE1">FP_A_END</a></td>
<td class="comment-1" rowspan="1">Jump if in range.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2DDE"></span>2DDE</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="1">Fetch the result and the flags.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2DDF"></span>2DDF</td>
<td class="instruction">SCF</td>
<td class="comment-1" rowspan="1">Signal the result is out of range.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2DE0"></span>2DE0</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Finished - unsuccessful.</td>
</tr>
<tr>
<td class="asm-label">FP_A_END</td>
<td class="address-2"><span id="2DE1"></span>2DE1</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="1">Fetch the result and the flags.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2DE2"></span>2DE2</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Finished - successful.</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="2DC1.html">2DC1</a>
</td>
<td class="up">Up: <a href="../maps/all.html#2DD5">Map</a></td>
<td class="next">
Next: <a href="2DE3.html">2DE3</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Spectrum ROM Disassembly 20221121</div>
<div class="copyright">&#169; 1982 Amstrad. &#169; 1983 Dr Ian Logan &amp; Dr Frank O'Hara. &#169; 2022 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.8.</div>
<div><a href="../dec/asm/11733.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>