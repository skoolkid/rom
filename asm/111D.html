<!DOCTYPE html>
<html>
<head>
<title>Spectrum ROM: Routine at 111D</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Spectrum ROM" src="../images/logo-hex.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="10A8.html">10A8</a>
</td>
<td class="up">Up: <a href="../maps/all.html#111D">Map</a></td>
<td class="next">
Next: <a href="1190.html">1190</a>
</td>
</tr>
</table>
<div class="description">111D: THE 'LOWER SCREEN COPYING' SUBROUTINE</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="10A8.html">KEY_INPUT</a> and <a href="2089.html">INPUT</a>.
</div>
<div class="paragraph">
This subroutine is called whenever the line in the editing area or the INPUT area is to be printed in the lower part of the screen.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ED_COPY</td>
<td class="address-2"><span id="111D"></span>111D</td>
<td class="instruction">CALL <a href="0D4D.html">TEMPS</a></td>
<td class="comment-1" rowspan="1">Use the permanent colours.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1120"></span>1120</td>
<td class="instruction">RES 3,(IY+$02)</td>
<td class="comment-1" rowspan="2">Signal that the 'mode is to be considered unchanged' (reset bit 3 of <a href="5C3C.html">TV-FLAG</a>) and the 'lower screen does not need clearing' (reset bit 5).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1124"></span>1124</td>
<td class="instruction">RES 5,(IY+$02)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1128"></span>1128</td>
<td class="instruction">LD HL,($5C8A)</td>
<td class="comment-1" rowspan="2">Save the current value of <a href="5C8A.html">S-POSNL</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="112B"></span>112B</td>
<td class="instruction">PUSH HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="112C"></span>112C</td>
<td class="instruction">LD HL,($5C3D)</td>
<td class="comment-1" rowspan="2">Keep the current value of <a href="5C3D.html">ERR-SP</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="112F"></span>112F</td>
<td class="instruction">PUSH HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1130"></span>1130</td>
<td class="instruction">LD HL,$1167</td>
<td class="comment-1" rowspan="1">This is <a href="111D.html#1167">ED_FULL</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1133"></span>1133</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="2">Push this address on to the machine stack to make <a href="111D.html#1167">ED_FULL</a> the entry point following an error (see <a href="5C3D.html">ERR-SP</a>).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1134"></span>1134</td>
<td class="instruction">LD ($5C3D),SP</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1138"></span>1138</td>
<td class="instruction">LD HL,($5C82)</td>
<td class="comment-1" rowspan="2">Push the value of <a href="5C82.html">ECHO-E</a> on to the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="113B"></span>113B</td>
<td class="instruction">PUSH HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="113C"></span>113C</td>
<td class="instruction">SCF</td>
<td class="comment-1" rowspan="3">Make <span class="register">HL</span> point to the start of the space and <span class="register">DE</span> the end.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="113D"></span>113D</td>
<td class="instruction">CALL <a href="1190.html#1195">SET_DE</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1140"></span>1140</td>
<td class="instruction">EX DE,HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1141"></span>1141</td>
<td class="instruction">CALL <a href="1855.html#187D">OUT_LINE2</a></td>
<td class="comment-1" rowspan="1">Now print the line.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1144"></span>1144</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="2">Exchange the pointers and print the cursor.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1145"></span>1145</td>
<td class="instruction">CALL <a href="18E1.html">OUT_CURS</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1148"></span>1148</td>
<td class="instruction">LD HL,($5C8A)</td>
<td class="comment-1" rowspan="2">Next fetch the current value of <a href="5C8A.html">S-POSNL</a> and exchange it with <a href="5C82.html">ECHO-E</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="114B"></span>114B</td>
<td class="instruction">EX (SP),HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="114C"></span>114C</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Pass <a href="5C82.html">ECHO-E</a> to <span class="register">DE</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="114D"></span>114D</td>
<td class="instruction">CALL <a href="0D4D.html">TEMPS</a></td>
<td class="comment-1" rowspan="1">Again fetch the permanent colours.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="1150"></span>
<div class="comments">
<div class="paragraph">
The remainder of any line that has been started is now completed with spaces printed with the 'permanent' PAPER colour.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ED_BLANK</td>
<td class="address-2"><span id="1150"></span>1150</td>
<td class="instruction">LD A,($5C8B)</td>
<td class="comment-1" rowspan="2">Fetch the current line number from <a href="5C8A.html">S-POSNL</a> and subtract the old line number.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1153"></span>1153</td>
<td class="instruction">SUB D</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1154"></span>1154</td>
<td class="instruction">JR C,<a href="111D.html#117C">ED_C_DONE</a></td>
<td class="comment-1" rowspan="1">Jump forward if no 'blanking' of lines required.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1156"></span>1156</td>
<td class="instruction">JR NZ,<a href="111D.html#115E">ED_SPACES</a></td>
<td class="comment-1" rowspan="1">Jump forward if not on the same line.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1158"></span>1158</td>
<td class="instruction">LD A,E</td>
<td class="comment-1" rowspan="2">Fetch the old column number and subtract the new column number (at <a href="5C8A.html">S-POSNL</a>).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1159"></span>1159</td>
<td class="instruction">SUB (IY+$50)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="115C"></span>115C</td>
<td class="instruction">JR NC,<a href="111D.html#117C">ED_C_DONE</a></td>
<td class="comment-1" rowspan="1">Jump if no spaces required.</td>
</tr>
<tr>
<td class="asm-label">ED_SPACES</td>
<td class="address-2"><span id="115E"></span>115E</td>
<td class="instruction">LD A," "</td>
<td class="comment-1" rowspan="1">A 'space'.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1160"></span>1160</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1">Save the old values.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1161"></span>1161</td>
<td class="instruction">CALL <a href="09F4.html">PRINT_OUT</a></td>
<td class="comment-1" rowspan="1">Print it.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1164"></span>1164</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1">Fetch the old values.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1165"></span>1165</td>
<td class="instruction">JR <a href="111D.html#1150">ED_BLANK</a></td>
<td class="comment-1" rowspan="1">Back again.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="1167"></span>
<div class="comments">
<div class="paragraph">
New deal with any errors.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ED_FULL</td>
<td class="address-1"><span id="1167"></span>1167</td>
<td class="instruction">LD D,$00</td>
<td class="comment-1" rowspan="4">Give out a 'rasp' (see <a href="5C38.html">RASP</a>).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1169"></span>1169</td>
<td class="instruction">LD E,(IY-$02)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="116C"></span>116C</td>
<td class="instruction">LD HL,$1A90</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="116F"></span>116F</td>
<td class="instruction">CALL <a href="03B5.html">BEEPER</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1172"></span>1172</td>
<td class="instruction">LD (IY+$00),$FF</td>
<td class="comment-1" rowspan="1">Cancel the error number (<a href="5C3A.html">ERR-NR</a>).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1176"></span>1176</td>
<td class="instruction">LD DE,($5C8A)</td>
<td class="comment-1" rowspan="2">Fetch the current value of <a href="5C8A.html">S-POSNL</a> and jump forward.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="117A"></span>117A</td>
<td class="instruction">JR <a href="111D.html#117E">ED_C_END</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="117C"></span>
<div class="comments">
<div class="paragraph">
The normal exit upon completion of the copying over of the edit or the INPUT line.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ED_C_DONE</td>
<td class="address-2"><span id="117C"></span>117C</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1">The new position value.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="117D"></span>117D</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">The 'error address'.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="117E"></span>
<div class="comments">
<div class="paragraph">
But come here after an error.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ED_C_END</td>
<td class="address-2"><span id="117E"></span>117E</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="2">The old value of <a href="5C3D.html">ERR-SP</a> is restored.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="117F"></span>117F</td>
<td class="instruction">LD ($5C3D),HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1182"></span>1182</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Fetch the old value of <a href="5C8A.html">S-POSNL</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1183"></span>1183</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1">Save the new position values.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1184"></span>1184</td>
<td class="instruction">CALL <a href="0DD9.html">CL_SET</a></td>
<td class="comment-1" rowspan="1">Set the system variables.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1187"></span>1187</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="2">The old value of <a href="5C8A.html">S-POSNL</a> goes into <a href="5C82.html">ECHO-E</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1188"></span>1188</td>
<td class="instruction">LD ($5C82),HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="118B"></span>118B</td>
<td class="instruction">LD (IY+$26),$00</td>
<td class="comment-1" rowspan="2"><a href="5C5F.html">X-PTR</a> is cleared in a suitable manner and the return made.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="118F"></span>118F</td>
<td class="instruction">RET</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="10A8.html">10A8</a>
</td>
<td class="up">Up: <a href="../maps/all.html#111D">Map</a></td>
<td class="next">
Next: <a href="1190.html">1190</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Spectrum ROM Disassembly 20200807</div>
<div class="copyright">&#169; 1982 Amstrad. &#169; 1983 Dr Ian Logan &amp; Dr Frank O'Hara. &#169; 2020 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
<div><a href="../dec/asm/4381.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>