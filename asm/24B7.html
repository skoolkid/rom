<!DOCTYPE html>
<html>
<head>
<title>Spectrum ROM: Routine at 24B7</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Spectrum ROM" src="../images/logo-hex.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="247D.html">247D</a>
</td>
<td class="up">Up: <a href="../maps/all.html#24B7">Map</a></td>
<td class="next">
Next: <a href="24FB.html">24FB</a>
</td>
</tr>
</table>
<div class="description">24B7: THE 'LINE-DRAWING' SUBROUTINE</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
This subroutine is called by <a href="2382.html">DRAW</a> to draw an approximation to a straight line from the point X0, Y0 held in <a href="5C7D.html">COORDS</a> to the point X0+X, Y0+Y, where the increments X and Y are on the top of the calculator stack. The subroutine was originally intended for the ZX80 and ZX81 8K ROM, and it is described in a BASIC program on page 121 of the ZX81 manual.
</div>
<div class="paragraph">
The method is to intersperse as many horizontal or vertical steps as are needed among a basic set of diagonal steps, using an algorithm that spaces the horizontal or vertical steps as evenly as possible.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">DRAW_LINE</td>
<td class="address-2"><span id="24B7"></span>24B7</td>
<td class="instruction">CALL <a href="2307.html">STK_TO_BC</a></td>
<td class="comment-1" rowspan="1">ABS Y to <span class="register">B</span>; ABS X to <span class="register">C</span>; SGN Y to <span class="register">D</span>; SGN X to <span class="register">E</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24BA"></span>24BA</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="4">Jump if ABS X is greater than or equal to ABS Y, so that the smaller goes to <span class="register">L</span>, and the larger (later) goes to <span class="register">H</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24BB"></span>24BB</td>
<td class="instruction">CP B</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24BC"></span>24BC</td>
<td class="instruction">JR NC,<a href="24B7.html#24C4">DL_X_GE_Y</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24BE"></span>24BE</td>
<td class="instruction">LD L,C</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24BF"></span>24BF</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1">Save diagonal step (+/-1,+/-1) in <span class="register">DE</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24C0"></span>24C0</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="2">Insert a vertical step (+/-1,0) into <span class="register">DE</span> (<span class="register">D</span> holds SGN Y).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24C1"></span>24C1</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24C2"></span>24C2</td>
<td class="instruction">JR <a href="24B7.html#24CB">DL_LARGER</a></td>
<td class="comment-1" rowspan="1">Now jump to set <span class="register">H</span>.</td>
</tr>
<tr>
<td class="asm-label">DL_X_GE_Y</td>
<td class="address-2"><span id="24C4"></span>24C4</td>
<td class="instruction">OR C</td>
<td class="comment-1" rowspan="2">Return if ABS X and ABS Y are both zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24C5"></span>24C5</td>
<td class="instruction">RET Z</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24C6"></span>24C6</td>
<td class="instruction">LD L,B</td>
<td class="comment-1" rowspan="1">The smaller (ABS Y here) goes to <span class="register">L</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24C7"></span>24C7</td>
<td class="instruction">LD B,C</td>
<td class="comment-1" rowspan="1">ABS X to <span class="register">B</span> here, for <span class="register">H</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24C8"></span>24C8</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1">Save the diagonal step here too.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24C9"></span>24C9</td>
<td class="instruction">LD D,$00</td>
<td class="comment-1" rowspan="1">Horizontal step (0,+/-1) to <span class="register">DE</span> here.</td>
</tr>
<tr>
<td class="asm-label">DL_LARGER</td>
<td class="address-2"><span id="24CB"></span>24CB</td>
<td class="instruction">LD H,B</td>
<td class="comment-1" rowspan="1">Larger of ABS X, ABS Y to <span class="register">H</span> now.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="24CC"></span>
<div class="comments">
<div class="paragraph">
The algorithm starts here. The larger of ABS X and ABS Y, say <span class="register">H</span>, is put into <span class="register">A</span> and reduced to INT (<span class="register">H</span>/2). The <span class="register">H</span>-<span class="register">L</span> horizontal or vertical steps and <span class="register">L</span> diagonal steps are taken (where <span class="register">L</span> is the smaller of ABS X and ABS Y) in this way: <span class="register">L</span> is added to <span class="register">A</span>; if <span class="register">A</span> now equals or exceeds <span class="register">H</span>, it is reduced by <span class="register">H</span> and a diagonal step is taken; otherwise a horizontal or vertical step is taken. This is repeated <span class="register">H</span> times (<span class="register">B</span> also holds <span class="register">H</span>). Note that meanwhile the exchange registers <span class="register">H'</span> and <span class="register">L'</span> are used to hold <a href="5C7D.html">COORDS</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24CC"></span>24CC</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="1"><span class="register">B</span> to <span class="register">A</span> as well as to <span class="register">H</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24CD"></span>24CD</td>
<td class="instruction">RRA</td>
<td class="comment-1" rowspan="1"><span class="register">A</span> starts at INT (<span class="register">H</span>/2).</td>
</tr>
<tr>
<td class="asm-label">D_L_LOOP</td>
<td class="address-2"><span id="24CE"></span>24CE</td>
<td class="instruction">ADD A,L</td>
<td class="comment-1" rowspan="1"><span class="register">L</span> is added to <span class="register">A</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24CF"></span>24CF</td>
<td class="instruction">JR C,<a href="24B7.html#24D4">D_L_DIAG</a></td>
<td class="comment-1" rowspan="1">If 256 or more, jump - diagonal step.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24D1"></span>24D1</td>
<td class="instruction">CP H</td>
<td class="comment-1" rowspan="2">If <span class="register">A</span> is less than <span class="register">H</span>, jump for horizontal or vertical step.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24D2"></span>24D2</td>
<td class="instruction">JR C,<a href="24B7.html#24DB">D_L_HR_VT</a></td>
</tr>
<tr>
<td class="asm-label">D_L_DIAG</td>
<td class="address-2"><span id="24D4"></span>24D4</td>
<td class="instruction">SUB H</td>
<td class="comment-1" rowspan="1">Reduce <span class="register">A</span> by <span class="register">H</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24D5"></span>24D5</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">Restore it to <span class="register">C</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24D6"></span>24D6</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1">Now use the exchange resisters.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24D7"></span>24D7</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Diagonal step to <span class="register">BC'</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24D8"></span>24D8</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Save it too.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24D9"></span>24D9</td>
<td class="instruction">JR <a href="24B7.html#24DF">D_L_STEP</a></td>
<td class="comment-1" rowspan="1">Jump to take the step.</td>
</tr>
<tr>
<td class="asm-label">D_L_HR_VT</td>
<td class="address-2"><span id="24DB"></span>24DB</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">Save <span class="register">A</span> (unreduced) in <span class="register">C</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24DC"></span>24DC</td>
<td class="instruction">PUSH DE</td>
<td class="comment-1" rowspan="1">Step to stack briefly.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24DD"></span>24DD</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1">Get exchange registers.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24DE"></span>24DE</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Step to <span class="register">BC'</span> now.</td>
</tr>
<tr>
<td class="asm-label">D_L_STEP</td>
<td class="address-2"><span id="24DF"></span>24DF</td>
<td class="instruction">LD HL,($5C7D)</td>
<td class="comment-1" rowspan="1">Now take the step: first, <a href="5C7D.html">COORDS</a> to <span class="register">HL'</span> as the start point.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24E2"></span>24E2</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="1">Y-step from <span class="register">B'</span> to <span class="register">A</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24E3"></span>24E3</td>
<td class="instruction">ADD A,H</td>
<td class="comment-1" rowspan="1">Add in <span class="register">H'</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24E4"></span>24E4</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">Result to <span class="register">B'</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24E5"></span>24E5</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="2">Now the X-step; it will be tested for range (Y will be tested in <a href="22DC.html">PLOT</a>).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24E6"></span>24E6</td>
<td class="instruction">INC A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24E7"></span>24E7</td>
<td class="instruction">ADD A,L</td>
<td class="comment-1" rowspan="2">Add <span class="register">L'</span> to <span class="register">C'</span> in <span class="register">A</span>, jump on carry for further test.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24E8"></span>24E8</td>
<td class="instruction">JR C,<a href="24B7.html#24F7">D_L_RANGE</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24EA"></span>24EA</td>
<td class="instruction">JR Z,<a href="24B7.html#24F9">REPORT_B_3</a></td>
<td class="comment-1" rowspan="1">Zero after no carry denotes X-position -1, out of range.</td>
</tr>
<tr>
<td class="asm-label">D_L_PLOT</td>
<td class="address-2"><span id="24EC"></span>24EC</td>
<td class="instruction">DEC A</td>
<td class="comment-1" rowspan="1">Restore true value to <span class="register">A</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24ED"></span>24ED</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">Value to <span class="register">C'</span> for plotting.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24EE"></span>24EE</td>
<td class="instruction">CALL <a href="22DC.html#22E5">PLOT_SUB</a></td>
<td class="comment-1" rowspan="1">Plot the step.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24F1"></span>24F1</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1">Restore main registers.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24F2"></span>24F2</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="1"><span class="register">C</span> back to <span class="register">A</span> to continue algorithm.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24F3"></span>24F3</td>
<td class="instruction">DJNZ <a href="24B7.html#24CE">D_L_LOOP</a></td>
<td class="comment-1" rowspan="1">Loop back for <span class="register">B</span> steps (i.e. <span class="register">H</span> steps).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24F5"></span>24F5</td>
<td class="instruction">POP DE</td>
<td class="comment-1" rowspan="1">Clear machine stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24F6"></span>24F6</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Finished.</td>
</tr>
<tr>
<td class="asm-label">D_L_RANGE</td>
<td class="address-2"><span id="24F7"></span>24F7</td>
<td class="instruction">JR Z,<a href="24B7.html#24EC">D_L_PLOT</a></td>
<td class="comment-1" rowspan="1">Zero after carry denotes X-position 255, in range.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="24F9"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routines at <a href="22AA.html">PIXEL_ADD</a> and <a href="2314.html">STK_TO_A</a>.
</div>
<div class="paragraph">
Report B - Integer out of range.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">REPORT_B_3</td>
<td class="address-2"><span id="24F9"></span>24F9</td>
<td class="instruction">RST <a href="0008.html">$08</a></td>
<td class="comment-1" rowspan="2">Call the error handling routine.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="24FA"></span>24FA</td>
<td class="instruction">DEFB $0A</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="247D.html">247D</a>
</td>
<td class="up">Up: <a href="../maps/all.html#24B7">Map</a></td>
<td class="next">
Next: <a href="24FB.html">24FB</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Spectrum ROM Disassembly 20221121</div>
<div class="copyright">&#169; 1982 Amstrad. &#169; 1983 Dr Ian Logan &amp; Dr Frank O'Hara. &#169; 2022 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.8.</div>
<div><a href="../dec/asm/9399.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>