<!DOCTYPE html>
<html>
<head>
<title>Spectrum ROM: Routine at 2F9B</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Spectrum ROM" src="../images/logo-hex.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="2F8B.html">2F8B</a>
</td>
<td class="up">Up: <a href="../maps/all.html#2F9B">Map</a></td>
<td class="next">
Next: <a href="2FBA.html">2FBA</a>
</td>
</tr>
</table>
<div class="description">2F9B: THE 'PREPARE TO ADD' SUBROUTINE</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="3014.html">addition</a>.
</div>
<div class="paragraph">
This subroutine is the first of four subroutines that are used by the main arithmetic operation routines - <a href="300F.html">subtract</a>, <a href="3014.html">addition</a>, <a href="30CA.html">multiply</a> and <a href="31AF.html">division</a>.
</div>
<div class="paragraph">
This particular subroutine prepares a floating-point number for addition, mainly by replacing the sign bit with a true numerical bit 1, and negating the number (two's complement) if it is negative. The exponent is returned in the <span class="register">A</span> register and the first byte is set to +00 for a positive number and +FF for a negative number.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">HL</td>
<td class="register-desc">Address of the first byte of the number</td>
</tr>
</table>
<table class="output">
<tr class="asm-output-header">
<th colspan="2">Output</th>
</tr>
<tr>
<td class="register">A</td>
<td class="register-desc">Exponent byte</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="asm-label">PREP_ADD</td>
<td class="address-2"><span id="2F9B"></span>2F9B</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Transfer the exponent to <span class="register">A</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2F9C"></span>2F9C</td>
<td class="instruction">LD (HL),$00</td>
<td class="comment-1" rowspan="1">Presume a positive number.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2F9E"></span>2F9E</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="2">If the number is zero then the preparation is already finished.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2F9F"></span>2F9F</td>
<td class="instruction">RET Z</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FA0"></span>2FA0</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Now point to the sign byte.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FA1"></span>2FA1</td>
<td class="instruction">BIT 7,(HL)</td>
<td class="comment-1" rowspan="1">Set the zero flag for positive number.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FA3"></span>2FA3</td>
<td class="instruction">SET 7,(HL)</td>
<td class="comment-1" rowspan="1">Restore the true numeric bit.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FA5"></span>2FA5</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="1">Point to the first byte again.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FA6"></span>2FA6</td>
<td class="instruction">RET Z</td>
<td class="comment-1" rowspan="1">Positive numbers have been prepared, but negative numbers need to be two's complemented.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FA7"></span>2FA7</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Save any earlier exponent.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FA8"></span>2FA8</td>
<td class="instruction">LD BC,$0005</td>
<td class="comment-1" rowspan="1">There are 5 bytes to be handled.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FAB"></span>2FAB</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-1" rowspan="1">Point one past the last byte.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FAC"></span>2FAC</td>
<td class="instruction">LD B,C</td>
<td class="comment-1" rowspan="1">Transfer the 5 to <span class="register">B</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FAD"></span>2FAD</td>
<td class="instruction">LD C,A</td>
<td class="comment-1" rowspan="1">Save the exponent in <span class="register">C</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FAE"></span>2FAE</td>
<td class="instruction">SCF</td>
<td class="comment-1" rowspan="1">Set carry flag for negation.</td>
</tr>
<tr>
<td class="asm-label">NEG_BYTE</td>
<td class="address-2"><span id="2FAF"></span>2FAF</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="1">Point to each byte in turn.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FB0"></span>2FB0</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="1">Get each byte.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FB1"></span>2FB1</td>
<td class="instruction">CPL</td>
<td class="comment-1" rowspan="1">One's complement the byte.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FB2"></span>2FB2</td>
<td class="instruction">ADC A,$00</td>
<td class="comment-1" rowspan="1">Add in carry for negation.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FB4"></span>2FB4</td>
<td class="instruction">LD (HL),A</td>
<td class="comment-1" rowspan="1">Restore the byte.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FB5"></span>2FB5</td>
<td class="instruction">DJNZ <a href="2F9B.html#2FAF">NEG_BYTE</a></td>
<td class="comment-1" rowspan="1">Loop 5 times.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FB7"></span>2FB7</td>
<td class="instruction">LD A,C</td>
<td class="comment-1" rowspan="1">Restore the exponent to <span class="register">A</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FB8"></span>2FB8</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore any earlier exponent.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FB9"></span>2FB9</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Finished.</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="2F8B.html">2F8B</a>
</td>
<td class="up">Up: <a href="../maps/all.html#2F9B">Map</a></td>
<td class="next">
Next: <a href="2FBA.html">2FBA</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Spectrum ROM Disassembly 20200807</div>
<div class="copyright">&#169; 1982 Amstrad. &#169; 1983 Dr Ian Logan &amp; Dr Frank O'Hara. &#169; 2020 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
<div><a href="../dec/asm/12187.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>