<!DOCTYPE html>
<html>
<head>
<title>Spectrum ROM: Routine at 1D03</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Spectrum ROM" src="../images/logo-hex.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="1CF0.html">1CF0</a>
</td>
<td class="up">Up: <a href="../maps/all.html#1D03">Map</a></td>
<td class="next">
Next: <a href="1D86.html">1D86</a>
</td>
</tr>
</table>
<div class="description">1D03: THE 'FOR' COMMAND ROUTINE</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
The address of this routine is found in the <a href="1A48.html#1A90">parameter table</a>.
</div>
<div class="paragraph">
This command routine is entered with the VALUE and the LIMIT of the FOR statement already on the top of the calculator stack.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">A</td>
<td class="register-desc">Code of the next character in the statement</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="asm-label">FOR</td>
<td class="address-2"><span id="1D03"></span>1D03</td>
<td class="instruction">CP $CD</td>
<td class="comment-1" rowspan="2">Jump forward unless a 'STEP' is given.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D05"></span>1D05</td>
<td class="instruction">JR NZ,<a href="1D03.html#1D10">F_USE_1</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D07"></span>1D07</td>
<td class="instruction">RST <a href="0020.html">$20</a></td>
<td class="comment-1" rowspan="2">Advance <a href="5C5D.html">CH-ADD</a> and fetch the value of the STEP.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D08"></span>1D08</td>
<td class="instruction">CALL <a href="1C79.html#1C82">CLASS_06</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D0B"></span>1D0B</td>
<td class="instruction">CALL <a href="1BEE.html">CHECK_END</a></td>
<td class="comment-1" rowspan="2">Move on to the next statement if checking syntax; otherwise jump forward.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D0E"></span>1D0E</td>
<td class="instruction">JR <a href="1D03.html#1D16">F_REORDER</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="1D10"></span>
<div class="comments">
<div class="paragraph">
There has not been a STEP supplied so the value '1' is to be used.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">F_USE_1</td>
<td class="address-2"><span id="1D10"></span>1D10</td>
<td class="instruction">CALL <a href="1BEE.html">CHECK_END</a></td>
<td class="comment-1" rowspan="1">Move on to the next statement if checking syntax.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D13"></span>1D13</td>
<td class="instruction">RST <a href="0028.html">$28</a></td>
<td class="comment-1" rowspan="1">Otherwise use the calculator to place a '1' on the calculator stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D14"></span>1D14</td>
<td class="instruction">DEFB $A1</td>
<td class="comment-1" rowspan="1"><a href="341B.html">stk_one</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D15"></span>1D15</td>
<td class="instruction">DEFB $38</td>
<td class="comment-1" rowspan="1"><a href="369B.html">end_calc</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="1D16"></span>
<div class="comments">
<div class="paragraph">
The three values on the calculator stack are the VALUE (v), the LIMIT (l) and the STEP (s). These values now have to be manipulated.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">F_REORDER</td>
<td class="address-2"><span id="1D16"></span>1D16</td>
<td class="instruction">RST <a href="0028.html">$28</a></td>
<td class="comment-1" rowspan="1">v, l, s</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D17"></span>1D17</td>
<td class="instruction">DEFB $C0</td>
<td class="comment-1" rowspan="1"><a href="342D.html">st_mem_0</a>: v, l, s (mem-0=s)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D18"></span>1D18</td>
<td class="instruction">DEFB $02</td>
<td class="comment-1" rowspan="1"><a href="335B.html#33A1">delete</a>: v, l</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D19"></span>1D19</td>
<td class="instruction">DEFB $01</td>
<td class="comment-1" rowspan="1"><a href="343C.html">exchange</a>: l, v</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D1A"></span>1D1A</td>
<td class="instruction">DEFB $E0</td>
<td class="comment-1" rowspan="1"><a href="340F.html">get_mem_0</a>: l, v, s</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D1B"></span>1D1B</td>
<td class="instruction">DEFB $01</td>
<td class="comment-1" rowspan="1"><a href="343C.html">exchange</a>: l, s, v</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D1C"></span>1D1C</td>
<td class="instruction">DEFB $38</td>
<td class="comment-1" rowspan="1"><a href="369B.html">end_calc</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="1D1D"></span>
<div class="comments">
<div class="paragraph">
A FOR control variable is now established and treated as a temporary calculator memory area.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D1D"></span>1D1D</td>
<td class="instruction">CALL <a href="2AFF.html">LET</a></td>
<td class="comment-1" rowspan="1">The variable is found, or created if needed (v is used).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D20"></span>1D20</td>
<td class="instruction">LD ($5C68),HL</td>
<td class="comment-1" rowspan="1">Make it a 'memory area' by setting <a href="5C68.html">MEM</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="1D23"></span>
<div class="comments">
<div class="paragraph">
The variable that has been found may be a simple numeric variable using only six locations in which case it will need extending.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D23"></span>1D23</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="2">Fetch the variable's single character name.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D24"></span>1D24</td>
<td class="instruction">LD A,(HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D25"></span>1D25</td>
<td class="instruction">SET 7,(HL)</td>
<td class="comment-1" rowspan="1">Ensure bit 7 of the name is set.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D27"></span>1D27</td>
<td class="instruction">LD BC,$0006</td>
<td class="comment-1" rowspan="1">It will have six locations at least.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D2A"></span>1D2A</td>
<td class="instruction">ADD HL,BC</td>
<td class="comment-1" rowspan="1">Make <span class="register">HL</span> point after them.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D2B"></span>1D2B</td>
<td class="instruction">RLCA</td>
<td class="comment-1" rowspan="2">Rotate the name and jump if it was already a FOR variable.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D2C"></span>1D2C</td>
<td class="instruction">JR C,<a href="1D03.html#1D34">F_L_S</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D2E"></span>1D2E</td>
<td class="instruction">LD C,$0D</td>
<td class="comment-1" rowspan="2">Otherwise create thirteen more locations.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D30"></span>1D30</td>
<td class="instruction">CALL <a href="1652.html#1655">MAKE_ROOM</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D33"></span>1D33</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Again make <span class="register">HL</span> point to the LIMIT position.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="1D34"></span>
<div class="comments">
<div class="paragraph">
The initial values for the LIMIT and the STEP are now added.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">F_L_S</td>
<td class="address-2"><span id="1D34"></span>1D34</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">The pointer is saved.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D35"></span>1D35</td>
<td class="instruction">RST <a href="0028.html">$28</a></td>
<td class="comment-1" rowspan="1">l, s</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D36"></span>1D36</td>
<td class="instruction">DEFB $02</td>
<td class="comment-1" rowspan="1"><a href="335B.html#33A1">delete</a>: l</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D37"></span>1D37</td>
<td class="instruction">DEFB $02</td>
<td class="comment-1" rowspan="1"><a href="335B.html#33A1">delete</a>: -</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D38"></span>1D38</td>
<td class="instruction">DEFB $38</td>
<td class="comment-1" rowspan="1"><a href="369B.html">end_calc</a>: <span class="register">DE</span> still points to 'l'</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D39"></span>1D39</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="2">The pointer is restored and both pointers exchanged.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D3A"></span>1D3A</td>
<td class="instruction">EX DE,HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D3B"></span>1D3B</td>
<td class="instruction">LD C,$0A</td>
<td class="comment-1" rowspan="2">The ten bytes of the LIMIT and the STEP are moved.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D3D"></span>1D3D</td>
<td class="instruction">LDIR</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="1D3F"></span>
<div class="comments">
<div class="paragraph">
The looping line number and statement number are now entered.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D3F"></span>1D3F</td>
<td class="instruction">LD HL,($5C45)</td>
<td class="comment-1" rowspan="1">The current line number (<a href="5C45.html">PPC</a>).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D42"></span>1D42</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="4">Exchange the registers before adding the line number to the FOR control variable.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D43"></span>1D43</td>
<td class="instruction">LD (HL),E</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D44"></span>1D44</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D45"></span>1D45</td>
<td class="instruction">LD (HL),D</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D46"></span>1D46</td>
<td class="instruction">LD D,(IY+$0D)</td>
<td class="comment-1" rowspan="4">The looping statement is always the next statement whether it exists or not (increment <a href="5C47.html">SUBPPC</a>).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D49"></span>1D49</td>
<td class="instruction">INC D</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D4A"></span>1D4A</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D4B"></span>1D4B</td>
<td class="instruction">LD (HL),D</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="1D4C"></span>
<div class="comments">
<div class="paragraph">
The <a href="1DDA.html">NEXT_LOOP</a> subroutine is called to test the possibility of a 'pass' and a return is made if one is possible; otherwise the statement after for FOR - NEXT loop has to be identified.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D4C"></span>1D4C</td>
<td class="instruction">CALL <a href="1DDA.html">NEXT_LOOP</a></td>
<td class="comment-1" rowspan="1">Is a 'pass' possible?</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D4F"></span>1D4F</td>
<td class="instruction">RET NC</td>
<td class="comment-1" rowspan="1">Return now if it is.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D50"></span>1D50</td>
<td class="instruction">LD B,(IY+$38)</td>
<td class="comment-1" rowspan="1">Fetch the variable's name from <a href="5C72.html">STRLEN</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D53"></span>1D53</td>
<td class="instruction">LD HL,($5C45)</td>
<td class="comment-1" rowspan="2">Copy the present line number (<a href="5C45.html">PPC</a>) to <a href="5C42.html">NEWPPC</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D56"></span>1D56</td>
<td class="instruction">LD ($5C42),HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D59"></span>1D59</td>
<td class="instruction">LD A,($5C47)</td>
<td class="comment-1" rowspan="2">Fetch the current statement number (<a href="5C47.html">SUBPPC</a>) and two's complement it.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D5C"></span>1D5C</td>
<td class="instruction">NEG</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D5E"></span>1D5E</td>
<td class="instruction">LD D,A</td>
<td class="comment-1" rowspan="1">Transfer the result to the <span class="register">D</span> register.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D5F"></span>1D5F</td>
<td class="instruction">LD HL,($5C5D)</td>
<td class="comment-1" rowspan="1">Fetch the current value of <a href="5C5D.html">CH-ADD</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D62"></span>1D62</td>
<td class="instruction">LD E,$F3</td>
<td class="comment-1" rowspan="1">The search will be for 'NEXT'.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="1D64"></span>
<div class="comments">
<div class="paragraph">
Now a search is made in the program area, from the present point onwards, for the first occurrence of NEXT followed by the correct variable.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">F_LOOP</td>
<td class="address-2"><span id="1D64"></span>1D64</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Save the variable's name.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D65"></span>1D65</td>
<td class="instruction">LD BC,($5C55)</td>
<td class="comment-1" rowspan="1">Fetch the current value of <a href="5C55.html">NXTLIN</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D69"></span>1D69</td>
<td class="instruction">CALL <a href="1D86.html">LOOK_PROG</a></td>
<td class="comment-1" rowspan="1">The program area is now searched and <span class="register">BC</span> will change with each new line examined.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D6C"></span>1D6C</td>
<td class="instruction">LD ($5C55),BC</td>
<td class="comment-1" rowspan="1">Upon return save the pointer at <a href="5C55.html">NXTLIN</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D70"></span>1D70</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore the variable's name.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D71"></span>1D71</td>
<td class="instruction">JR C,<a href="1D03.html#1D84">REPORT_I</a></td>
<td class="comment-1" rowspan="1">If there are no further NEXTs then give an error.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D73"></span>1D73</td>
<td class="instruction">RST <a href="0020.html">$20</a></td>
<td class="comment-1" rowspan="1">Advance past the NEXT that was found.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D74"></span>1D74</td>
<td class="instruction">OR $20</td>
<td class="comment-1" rowspan="2">Allow for upper and lower case letters before the new variable name is tested.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D76"></span>1D76</td>
<td class="instruction">CP B</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D77"></span>1D77</td>
<td class="instruction">JR Z,<a href="1D03.html#1D7C">F_FOUND</a></td>
<td class="comment-1" rowspan="1">Jump forward if it matches.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D79"></span>1D79</td>
<td class="instruction">RST <a href="0020.html">$20</a></td>
<td class="comment-1" rowspan="2">Advance <a href="5C5D.html">CH-ADD</a> again and jump back if not the correct variable.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D7A"></span>1D7A</td>
<td class="instruction">JR <a href="1D03.html#1D64">F_LOOP</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="1D7C"></span>
<div class="comments">
<div class="paragraph">
<a href="5C42.html">NEWPPC</a> holds the line number of the line in which the correct NEXT was found. Now the statement number has to be found and stored in <a href="5C44.html">NSPPC</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">F_FOUND</td>
<td class="address-2"><span id="1D7C"></span>1D7C</td>
<td class="instruction">RST <a href="0020.html">$20</a></td>
<td class="comment-1" rowspan="1">Advance <a href="5C5D.html">CH-ADD</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D7D"></span>1D7D</td>
<td class="instruction">LD A,$01</td>
<td class="comment-1" rowspan="2">The statement counter in the <span class="register">D</span> register counted statements back from zero so it has to be subtracted from '1'.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D7F"></span>1D7F</td>
<td class="instruction">SUB D</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D80"></span>1D80</td>
<td class="instruction">LD ($5C44),A</td>
<td class="comment-1" rowspan="1">The result is stored in <a href="5C44.html">NSPPC</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D83"></span>1D83</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Now return - to <a href="1B76.html">STMT_RET</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="1D84"></span>
<div class="comments">
<div class="paragraph">
Report I - FOR without NEXT.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">REPORT_I</td>
<td class="address-2"><span id="1D84"></span>1D84</td>
<td class="instruction">RST <a href="0008.html">$08</a></td>
<td class="comment-1" rowspan="2">Call the error handling routine.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1D85"></span>1D85</td>
<td class="instruction">DEFB $11</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="1CF0.html">1CF0</a>
</td>
<td class="up">Up: <a href="../maps/all.html#1D03">Map</a></td>
<td class="next">
Next: <a href="1D86.html">1D86</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Spectrum ROM Disassembly 20200807</div>
<div class="copyright">&#169; 1982 Amstrad. &#169; 1983 Dr Ian Logan &amp; Dr Frank O'Hara. &#169; 2020 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
<div><a href="../dec/asm/7427.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>