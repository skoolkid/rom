<!DOCTYPE html>
<html>
<head>
<title>Spectrum ROM: Routine at 35DE</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Spectrum ROM" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="35C9.html">35C9</a>
</td>
<td class="up">Up: <a href="../maps/all.html#35DE">Map</a></td>
<td class="next">
Next: <a href="361F.html">361F</a>
</td>
</tr>
</table>
<div class="description">35DE: THE 'VAL' AND 'VAL$' FUNCTIONS (offsets +18, +1D)</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
The address of this routine is found in the <a href="32D7.html">table of addresses</a>. It is called indirectly via <a href="33A2.html">fp_calc_2</a>.
</div>
<div class="paragraph">
This subroutine handles the functions VAL X$ and VAL$ X$. When handling VAL X$, it returns a 'last value' that is the result of evaluating the string (without its bounding quotes) as a numerical expression. when handling VAL$ X$, it evaluates X$ (without its bounding quotes) as a string expression, and returns the parameters of that string expression as a 'last value' on the calculator stack.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">B</td>
<td class="register-desc">Offset (+18 or +1D)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="asm-label">val</td>
<td class="address-2"><span id="35DE"></span>35DE</td>
<td class="instruction">LD HL,($5C5D)</td>
<td class="comment-1" rowspan="2">The current value of <a href="5C5D.html">CH-ADD</a> is preserved on the machine stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="35E1"></span>35E1</td>
<td class="instruction">PUSH HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="35E2"></span>35E2</td>
<td class="instruction">LD A,B</td>
<td class="comment-1" rowspan="1">The 'offset' for 'val' or 'val$' must be in the <span class="register">B</span> register; it is now copied to <span class="register">A</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="35E3"></span>35E3</td>
<td class="instruction">ADD A,$E3</td>
<td class="comment-1" rowspan="1">Produce +00 and carry set for 'val', +FB and carry reset for 'val$'.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="35E5"></span>35E5</td>
<td class="instruction">SBC A,A</td>
<td class="comment-1" rowspan="1">Produce +FF (bit 6 therefore set) for 'val', but +00 (bit 6 reset) for 'val$'.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="35E6"></span>35E6</td>
<td class="instruction">PUSH AF</td>
<td class="comment-1" rowspan="1">Save this 'flag' on the machine stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="35E7"></span>35E7</td>
<td class="instruction">CALL <a href="2BF1.html">STK_FETCH</a></td>
<td class="comment-1" rowspan="4">The parameters of the string are fetched; the starting address is saved; one byte is added to the length and room made available for the string (+1) in the work space.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="35EA"></span>35EA</td>
<td class="instruction">PUSH DE</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="35EB"></span>35EB</td>
<td class="instruction">INC BC</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="35EC"></span>35EC</td>
<td class="instruction">RST <a href="0030.html">$30</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="35ED"></span>35ED</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">The starting address of the string goes to <span class="register">HL</span> as a source address.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="35EE"></span>35EE</td>
<td class="instruction">LD ($5C5D),DE</td>
<td class="comment-1" rowspan="2">The pointer to the first new space goes to <a href="5C5D.html">CH-ADD</a> and to the machine stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="35F2"></span>35F2</td>
<td class="instruction">PUSH DE</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="35F3"></span>35F3</td>
<td class="instruction">LDIR</td>
<td class="comment-1" rowspan="1">The string is copied to the work space, together with an extra byte.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="35F5"></span>35F5</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1">Switch the pointers.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="35F6"></span>35F6</td>
<td class="instruction">DEC HL</td>
<td class="comment-1" rowspan="2">The extra byte is replaced by a 'carriage return' character.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="35F7"></span>35F7</td>
<td class="instruction">LD (HL),$0D</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="35F9"></span>35F9</td>
<td class="instruction">RES 7,(IY+$01)</td>
<td class="comment-1" rowspan="2">The syntax flag (bit 7 of <a href="5C3B.html">FLAGS</a>) is reset and the string is scanned for correct syntax.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="35FD"></span>35FD</td>
<td class="instruction">CALL <a href="24FB.html">SCANNING</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3600"></span>3600</td>
<td class="instruction">RST <a href="0018.html">$18</a></td>
<td class="comment-1" rowspan="1">The character after the string is fetched.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3601"></span>3601</td>
<td class="instruction">CP $0D</td>
<td class="comment-1" rowspan="1">A check is made that the end of the expression has been reached.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3603"></span>3603</td>
<td class="instruction">JR NZ,<a href="35DE.html#360C">V_RPORT_C</a></td>
<td class="comment-1" rowspan="1">If not, the error is reported.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3605"></span>3605</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">The starting address of the string is fetched.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3606"></span>3606</td>
<td class="instruction">POP AF</td>
<td class="comment-1" rowspan="3">The 'flag' for 'val/val$' is fetched and bit 6 is compared with bit 6 of the result (<a href="5C3B.html">FLAGS</a>) of the syntax scan.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3607"></span>3607</td>
<td class="instruction">XOR (IY+$01)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="360A"></span>360A</td>
<td class="instruction">AND $40</td>
</tr>
<tr>
<td class="asm-label">V_RPORT_C</td>
<td class="address-2"><span id="360C"></span>360C</td>
<td class="instruction">JP NZ,<a href="1C79.html#1C8A">REPORT_C</a></td>
<td class="comment-1" rowspan="1">Report the error if they do not match.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="360F"></span>360F</td>
<td class="instruction">LD ($5C5D),HL</td>
<td class="comment-1" rowspan="1">Start address to <a href="5C5D.html">CH-ADD</a> again.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3612"></span>3612</td>
<td class="instruction">SET 7,(IY+$01)</td>
<td class="comment-1" rowspan="1">The flag (bit 7 of <a href="5C3B.html">FLAGS</a>) is set for line execution.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3616"></span>3616</td>
<td class="instruction">CALL <a href="24FB.html">SCANNING</a></td>
<td class="comment-1" rowspan="1">The string is treated as a 'next expression' and a 'last value' produced.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3619"></span>3619</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="2">The original value of <a href="5C5D.html">CH-ADD</a> is restored.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="361A"></span>361A</td>
<td class="instruction">LD ($5C5D),HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="361D"></span>361D</td>
<td class="instruction">JR <a href="35BF.html">STK_PNTRS</a></td>
<td class="comment-1" rowspan="1">The subroutine exits via <a href="35BF.html">STK_PNTRS</a> which resets the pointers.</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="35C9.html">35C9</a>
</td>
<td class="up">Up: <a href="../maps/all.html#35DE">Map</a></td>
<td class="next">
Next: <a href="361F.html">361F</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Spectrum ROM Disassembly 20191113</div>
<div class="copyright">&#169; 1982 Amstrad. &#169; 1983 Dr Ian Logan &amp; Dr Frank O'Hara. &#169; 2019 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.0.</div>
<div><a href="../dec/asm/13790.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>