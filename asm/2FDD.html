<!DOCTYPE html>
<html>
<head>
<title>Spectrum ROM: Routine at 2FDD</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Spectrum ROM" src="../images/logo-hex.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="2FBA.html">2FBA</a>
</td>
<td class="up">Up: <a href="../maps/all.html#2FDD">Map</a></td>
<td class="next">
Next: <a href="3004.html">3004</a>
</td>
</tr>
</table>
<div class="description">2FDD: THE 'SHIFT ADDEND' SUBROUTINE</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routines at <a href="2DE3.html">PRINT_FP</a> and <a href="3014.html">addition</a>.
</div>
<div class="paragraph">
This subroutine shifts a floating-point number up to 32 places right to line it up properly for addition. The number with the smaller exponent has been put in the addend position before this subroutine is called. Any overflow to the right, into the carry, is added back into the number. If the exponent difference is greater than 32, or the carry ripples right back to the beginning of the number then the number is set to zero so that the addition will not alter the other number (the augend).
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">A</td>
<td class="register-desc">Number of shifts to perform</td>
</tr>
<tr>
<td class="register">D'E'DE</td>
<td class="register-desc">Mantissa of number to shift right</td>
</tr>
<tr>
<td class="register">L'</td>
<td class="register-desc">Sign byte of number to shift right (+00 or +FF)</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="asm-label">SHIFT_FP</td>
<td class="address-2"><span id="2FDD"></span>2FDD</td>
<td class="instruction">AND A</td>
<td class="comment-1" rowspan="2">If the exponent difference is zero, the subroutine returns at once.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FDE"></span>2FDE</td>
<td class="instruction">RET Z</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FDF"></span>2FDF</td>
<td class="instruction">CP $21</td>
<td class="comment-1" rowspan="2">If the difference is greater than +20, jump forward.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FE1"></span>2FE1</td>
<td class="instruction">JR NC,<a href="2FDD.html#2FF9">ADDEND_0</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FE3"></span>2FE3</td>
<td class="instruction">PUSH BC</td>
<td class="comment-1" rowspan="1">Save <span class="register">BC</span> briefly.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FE4"></span>2FE4</td>
<td class="instruction">LD B,A</td>
<td class="comment-1" rowspan="1">Transfer the exponent difference to <span class="register">B</span> to count the shifts right.</td>
</tr>
<tr>
<td class="asm-label">ONE_SHIFT</td>
<td class="address-2"><span id="2FE5"></span>2FE5</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="2">Arithmetic shift right for <span class="register">L'</span>, preserving the sign marker bits.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FE6"></span>2FE6</td>
<td class="instruction">SRA L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FE8"></span>2FE8</td>
<td class="instruction">RR D</td>
<td class="comment-1" rowspan="5">Rotate right with carry <span class="register">D'</span>, <span class="register">E'</span>, <span class="register">D</span> and <span class="register">E</span>, thereby shifting the whole five bytes of the number to the right as many times as <span class="register">B</span> counts.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FEA"></span>2FEA</td>
<td class="instruction">RR E</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FEC"></span>2FEC</td>
<td class="instruction">EXX</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FED"></span>2FED</td>
<td class="instruction">RR D</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FEF"></span>2FEF</td>
<td class="instruction">RR E</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FF1"></span>2FF1</td>
<td class="instruction">DJNZ <a href="2FDD.html#2FE5">ONE_SHIFT</a></td>
<td class="comment-1" rowspan="1">Loop back until <span class="register">B</span> reaches zero.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FF3"></span>2FF3</td>
<td class="instruction">POP BC</td>
<td class="comment-1" rowspan="1">Restore the original <span class="register">BC</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FF4"></span>2FF4</td>
<td class="instruction">RET NC</td>
<td class="comment-1" rowspan="1">Done if no carry to retrieve.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FF5"></span>2FF5</td>
<td class="instruction">CALL <a href="3004.html">ADD_BACK</a></td>
<td class="comment-1" rowspan="1">Retrieve carry.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FF8"></span>2FF8</td>
<td class="instruction">RET NZ</td>
<td class="comment-1" rowspan="1">Return unless the carry rippled right back. (In this case there is nothing to add.)</td>
</tr>
<tr>
<td class="asm-label">ADDEND_0</td>
<td class="address-2"><span id="2FF9"></span>2FF9</td>
<td class="instruction">EXX</td>
<td class="comment-1" rowspan="1">Fetch <span class="register">L'</span>, <span class="register">D'</span> and <span class="register">E'</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FFA"></span>2FFA</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Clear the <span class="register">A</span> register.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="2FFB"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routine at <a href="30CA.html">multiply</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">ZEROS_4_5</td>
<td class="address-2"><span id="2FFB"></span>2FFB</td>
<td class="instruction">LD L,$00</td>
<td class="comment-1" rowspan="5">Set the addend to zero in <span class="register">D'</span>, <span class="register">E'</span>, <span class="register">D</span> and <span class="register">E</span>, together with its marker byte (sign indicator) <span class="register">L'</span>, which was +00 for a positive number and +FF for a negative number. This produces only 4 zero bytes when called for near underflow by <a href="30CA.html">multiply</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FFD"></span>2FFD</td>
<td class="instruction">LD D,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FFE"></span>2FFE</td>
<td class="instruction">LD E,L</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="2FFF"></span>2FFF</td>
<td class="instruction">EXX</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3000"></span>3000</td>
<td class="instruction">LD DE,$0000</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="3003"></span>3003</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Finished.</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="2FBA.html">2FBA</a>
</td>
<td class="up">Up: <a href="../maps/all.html#2FDD">Map</a></td>
<td class="next">
Next: <a href="3004.html">3004</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Spectrum ROM Disassembly 20200807</div>
<div class="copyright">&#169; 1982 Amstrad. &#169; 1983 Dr Ian Logan &amp; Dr Frank O'Hara. &#169; 2020 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.2.</div>
<div><a href="../dec/asm/12253.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>