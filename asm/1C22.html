<!DOCTYPE html>
<html>
<head>
<title>Spectrum ROM: Routine at 1C22</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../style.css" />
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="Spectrum ROM" src="../images/logo-hex.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="1C1F.html">1C1F</a>
</td>
<td class="up">Up: <a href="../maps/all.html#1C22">Map</a></td>
<td class="next">
Next: <a href="1C4E.html">1C4E</a>
</td>
</tr>
</table>
<div class="description">1C22: THE 'VARIABLE IN ASSIGNMENT' SUBROUTINE</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
Used by the routine at <a href="1C6C.html">CLASS_04</a>.
</div>
<div class="paragraph">
The routine at <a href="1C1F.html">CLASS_01</a> continues here.
</div>
<div class="paragraph">
This subroutine develops the appropriate values for the system variables <a href="5C4D.html">DEST</a> and <a href="5C72.html">STRLEN</a>.
</div>
</div>
<table class="input">
<tr class="asm-input-header">
<th colspan="2">Input</th>
</tr>
<tr>
<td class="register">C</td>
<td class="register-desc">Bit 5: Set if the variable is numeric, reset if it's a string</td>
</tr>
<tr>
<td class="register">C</td>
<td class="register-desc">Bit 6: Set if the variable is simple, reset if it's an array</td>
</tr>
<tr>
<td class="register">C</td>
<td class="register-desc">Bit 7: Set if checking syntax, reset if executing</td>
</tr>
<tr>
<td class="register">HL</td>
<td class="register-desc">Address of the last letter of the variable's name (in the variables area, if it exists)</td>
</tr>
<tr>
<td class="register">F</td>
<td class="register-desc">Carry flag reset if the variable already exists</td>
</tr>
<tr>
<td class="register">F</td>
<td class="register-desc">Zero flag reset if the variable is simple (not an array) and does not exist</td>
</tr>
</table>
</td>
</tr>
<tr>
<td class="asm-label">VAR_A_1</td>
<td class="address-2"><span id="1C22"></span>1C22</td>
<td class="instruction">LD (IY+$37),$00</td>
<td class="comment-1" rowspan="1">Initialise <a href="5C71.html">FLAGX</a> to +00.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1C26"></span>1C26</td>
<td class="instruction">JR NC,<a href="1C22.html#1C30">VAR_A_2</a></td>
<td class="comment-1" rowspan="1">Jump forward if the variable has been used before.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1C28"></span>1C28</td>
<td class="instruction">SET 1,(IY+$37)</td>
<td class="comment-1" rowspan="1">Signal 'a new variable' (set bit 1 of <a href="5C71.html">FLAGX</a>).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1C2C"></span>1C2C</td>
<td class="instruction">JR NZ,<a href="1C22.html#1C46">VAR_A_3</a></td>
<td class="comment-1" rowspan="1">Give an error if trying to use an 'undimensioned array'.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="1C2E"></span>
<div class="comments">
<div class="paragraph">
This entry point is used by the routines at <a href="1DAB.html">NEXT</a> and <a href="26C9.html">S_LETTER</a>.
</div>
<div class="paragraph">
Report 2 - Variable not found.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">REPORT_2</td>
<td class="address-2"><span id="1C2E"></span>1C2E</td>
<td class="instruction">RST <a href="0008.html">$08</a></td>
<td class="comment-1" rowspan="2">Call the error handling routine.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1C2F"></span>1C2F</td>
<td class="instruction">DEFB $01</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="1C30"></span>
<div class="comments">
<div class="paragraph">
Continue with the handling of existing variables.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">VAR_A_2</td>
<td class="address-2"><span id="1C30"></span>1C30</td>
<td class="instruction">CALL Z,<a href="2996.html">STK_VAR</a></td>
<td class="comment-1" rowspan="1">The parameters of simple string variables and all array variables are passed to the calculator stack. (<a href="2996.html">STK_VAR</a> will 'slice' a string if required.)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1C33"></span>1C33</td>
<td class="instruction">BIT 6,(IY+$01)</td>
<td class="comment-1" rowspan="2">Jump forward if handling a numeric variable (bit 6 of <a href="5C3B.html">FLAGS</a> set).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1C37"></span>1C37</td>
<td class="instruction">JR NZ,<a href="1C22.html#1C46">VAR_A_3</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1C39"></span>1C39</td>
<td class="instruction">XOR A</td>
<td class="comment-1" rowspan="1">Clear the <span class="register">A</span> register.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1C3A"></span>1C3A</td>
<td class="instruction">CALL <a href="2530.html">SYNTAX_Z</a></td>
<td class="comment-1" rowspan="2">The parameters of the string or string array variable are fetched unless syntax is being checked.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1C3D"></span>1C3D</td>
<td class="instruction">CALL NZ,<a href="2BF1.html">STK_FETCH</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1C40"></span>1C40</td>
<td class="instruction">LD HL,$5C71</td>
<td class="comment-1" rowspan="1">This is <a href="5C71.html">FLAGX</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1C43"></span>1C43</td>
<td class="instruction">OR (HL)</td>
<td class="comment-1" rowspan="2">Bit 0 is set only when handling complete 'simple strings' thereby signalling 'old copy to be deleted'.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1C44"></span>1C44</td>
<td class="instruction">LD (HL),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1C45"></span>1C45</td>
<td class="instruction">EX DE,HL</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span> now points to the string or the element of the array.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="1C46"></span>
<div class="comments">
<div class="paragraph">
The pathways now come together to set <a href="5C72.html">STRLEN</a> and <a href="5C4D.html">DEST</a> as required. For all numeric variables and 'new' string and string array variables <a href="5C72.html">STRLEN-lo</a> holds the 'letter' of the variable's name. But for 'old' string and string array variables whether 'sliced' or complete it holds the 'length' in 'assignment'.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">VAR_A_3</td>
<td class="address-2"><span id="1C46"></span>1C46</td>
<td class="instruction">LD ($5C72),BC</td>
<td class="comment-1" rowspan="1">Set <a href="5C72.html">STRLEN</a> as required.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="1C4A"></span>
<div class="comments">
<div class="paragraph">
<a href="5C4D.html">DEST</a> holds the address for the 'destination' of an 'old' variable but in effect the 'source' for a 'new' variable.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1C4A"></span>1C4A</td>
<td class="instruction">LD ($5C4D),HL</td>
<td class="comment-1" rowspan="2">Set <a href="5C4D.html">DEST</a> as required and return.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="1C4D"></span>1C4D</td>
<td class="instruction">RET</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="1C1F.html">1C1F</a>
</td>
<td class="up">Up: <a href="../maps/all.html#1C22">Map</a></td>
<td class="next">
Next: <a href="1C4E.html">1C4E</a>
</td>
</tr>
</table>
<footer>
<div class="release">The Complete Spectrum ROM Disassembly 20221121</div>
<div class="copyright">&#169; 1982 Amstrad. &#169; 1983 Dr Ian Logan &amp; Dr Frank O'Hara. &#169; 2022 Richard Dymond.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 8.8.</div>
<div><a href="../dec/asm/7202.html">Switch to decimal</a>.</div>
</footer>
</body>
</html>